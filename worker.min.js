class myWorker{constructor({openDelimiter:e="<%",closeDelimiter:t="%>"}={}){this.titleCode="",this.openDelimiter=e,this.closeDelimiter=t,this.commentDelimiter=e+"%",this.url="",this.titleCode=""}async readFurther(e,t){let r="";const l=await fetch(t);let i=await l.text();this.getTitle(i),this.url=t,"body"!==e&&(r=await this.changeCss(i));return{fileIncludedHTML:(await this.insertNestedHTML(i)).fileIncludedHTML,cssText:r,filename:this.currentUrl().filename,titleCode:this.titleCode}}findInclude(e){const t=/< *?body *?>[\s\S]*?< *?\/ *?body>/g,r=/ *?include\( *?["'`](.*?)["'`] *?\)/g,l=/ *?include\( *?["'`]/g,i=/["'`] *?\).*/g;let s=[],n=[],h="",o=0,a="";a=null===e.match(t)?e:e.match(t)[0].replace(/< *?body *?>/g,"").replace(/< *?\/ *?body *?>/g,"");let{codes:u,types:c}=this.seperateCode(a,"first"),p=c.length,d=this.currentUrl().host;for(let e=0;e<p;e++)"JS"==c[e]&&r.test(u[e])&&(h=u[e].match(r)[0].replace(l,"").replace(i,""),s.push(new URL(h,d).href),n[o]=e,o++);return{urls:s,orders:n,codeList:u}}async insertNestedHTML(e,t=[]){let r="",{urls:l,orders:i,codeList:s}=this.findInclude(e,t);if(0==l.length)return r=this.removeComment(s.join("")),{fileIncludedHTML:r,codeList:s};let n=[];l.forEach(((e,t)=>{n.push(this.getComparedPath(e,this.currentUrl().host))}));let h=await this.getTextFromFiles(l);for(let e=0;e<h.length;e++)h[e]=this.htmlReplaceRelativeUrl(h[e],n[e]);return h.forEach(((e,t)=>{s[i[t]]=e})),r=this.removeComment(s.join("")),({urls:l,orders:i,codeList:s}=this.findInclude(r,n)),0==l.length||({fileIncludedHTML:r,codeList:s}=await this.insertNestedHTML(r,n)),{fileIncludedHTML:r,codeList:s}}seperateCode(e,t){const r=`(${this.openDelimiter}[^%][\\s\\S]*?${this.closeDelimiter})`,l=new RegExp(r,"g");let i=e.split(l),s=[],n=i.length;for(let e=0;e<n;e++){let r=i[e],n=l.test(r)?"JS":"HTML";i[e]="JS"===n&&"second"===t?r.substring(2,r.length-2).trim():r,s.push(n)}let h=s.length;if(h>1)for(let e=h-1;e>=1;e--)s[e]==s[e-1]&&"HTML"==s[e]&&(i[e-1]=i[e-1]+i[e],i.splice(e,1),s.splice(e,1));return{types:s,codes:i}}getTitle(e){const t=/<head>[\s\S]*?<\/head>/g,r=/<title>[\s\S]*?<\/title>/g,l=null==e.match(t)?"":e.match(t)[0],i=null==l.match(r)?"":l.match(r)[0].replace("<title>","").replace("</title>","").trim();this.titleCode=i.length>0?i:this.titleCode}async changeCss(e){return e=this.removeComment(e),await this.combineCss(e)}async combineCss(e){let t=[],r=[],l=e.indexOf("<head>"),i=e.indexOf("</head>");if(-1==l||-1==i)return"";e.replace(/<style>[\s\S]*?<\/style>/gi,(function(e){return r.push(e.replaceAll("<style>","").replaceAll("</style>","")),""}));let s=r.join(""),n=[];e.replace(/<link.*?rel="stylesheet"[\s\S]*?\/?>/gi,(function(e){return n.push(e),""}));let h=this.currentUrl().host;n.forEach((e=>{let r=e.match(/href=".*?"/gi)[0].replaceAll("href=","").replaceAll('"',"");r.indexOf("http")<0&&t.push(new URL(r,h).href)}));let o=await this.getTextFromFiles(t),a=[];t.forEach((e=>{a.push(this.getComparedPath(e,this.currentUrl().host))}));for(let e=0;e<o.length;e++)o[e]=this.replaceRelativeUrl(o[e],a[e]);return s=o.reduce(((e,t)=>e+t),s),s=await this.insertNestedCSS(s),s}getOnlyPath(e){let t=e.split("/");return t.pop(),t.join("/")}splitUrl(e){let t=e.split("/");return""==t[t.length-1]&&t.pop(),""==t[0]&&t.shift(),t}getRelativeUrl(e){let t=this.currentUrl().host,r=this.splitUrl(e),l=this.splitUrl(t),i=[];for(let e=0;e<l.length;e++)l[e]!==r[e]?i.push(".."):r[e]=".";r=[...i,...r];for(let e=0;e<r.length;e++)"."==r[e]&&"."==r[e+1]&&(r[e]="_erase_");for(let e=r.length-1;e>=0;e--)("_erase_"==r[e]||"."==r[e]&&e>0)&&r.splice(e,1);return"/"+r.join("/")+"/"}getComparedPath(e,t){e=this.getOnlyPath(e),e=this.getRelativeUrl(e),t=this.getRelativeUrl(t);let r=this.splitUrl(e),l=this.splitUrl(t),i=[];for(let e=0;e<l.length;e++)l[e]!==r[e]?""!==l[e]&&i.push(".."):r[e]=".";return r=[...i,...r],r.join("/")+"/"}replaceRelativeUrl(e,t){function r(e,t){if(!e.includes("/"))return t+e;if("/"==e.substring(0,1))return t+e.substring(1);if("./"==e.substring(0,2))return t+e.substring(2);if("../"==e.substring(0,3)){let r=t.split("/");return r.pop(),r.pop(),(t=r.join("/")+"/")+e.substring(3)}}return e.replace(/(@import *['"])(.*?)(['"])|(url\(['"]?)(.*?)(['"]?\))/g,(function(e,l,i,s,n,h,o){return null==l?n+(h=r(h,t))+o:l+(i=r(i,t))+s}))}htmlReplaceRelativeUrl(e,t){function r(e,t){if(!e.includes("/"))return t+e;if("/"==e.substring(0,1))return t+e.substring(1);if("./"==e.substring(0,2))return t+e.substring(2);if("../"==e.substring(0,3)){let r=t.split("/");return r.pop(),r.pop(),(t=r.join("/")+"/")+e.substring(3)}}return e.replace(/(\<[a-z]* *src *= *['"`])((?!http|\<\%).*)(['"`])|(href *= *['"`])((?!http|\<\%|#).*[^\>\%])(['"`])|(\<\%[^\%] *include *\(?["'`])(.*)(["'`])/g,(function(e,l,i,s,n,h,o,a,u,c){return void 0!==l?l+(i=r(i,t))+s:void 0!==n?n+(h=r(h,t))+o:a+(u=r(u,t))+c}))}async insertNestedCSS(e){let t="",{urls:r,orders:l,codes:i,media:s}=this.findImport(e);if(0==r.length)return t=i.join(""),t;let n=await this.getTextFromFiles(r),h=[];r.forEach((e=>{h.push(this.getComparedPath(e,this.currentUrl().host))}));for(let e=0;e<n.length;e++)n[e]=this.replaceRelativeUrl(n[e],h[e]);return n.forEach(((e,t)=>{i[l[t]]=""!==s[t]?this.insertMedia(e,s[t]):e})),t=i.join(""),({urls:r,orders:l,codes:i,media:s}=this.findImport(t)),0!=r.length?(t=await this.insertNestedCSS(t),t):t}insertMedia(e,t){return`@media ${t} { ${e} }`}findImport(e){let t=[],r=[],l=[],i=[],s="",n=0;const h=/(@import *?(?:url)?\(?["'].*["']\)? *?.*;)/g,o=/[^(?:\.)|(?:\.\/)].*/g;let a=e.split(h);t=[...e.matchAll(/@import *?(url)?\(?["'](.*)["']\)? *?(.*);/g)];for(let e=0;e<a.length;e++)-1==a[e].search(h)||a[e].includes("http")?a[e]=this.removeControlText(a[e]).trim():(i[n]=e,n++);return t.forEach((e=>{s=e[2].match(o)[0].trim(),r.push(this.currentUrl().host+s),l.push(null===e[3]?"":e[3].trim())})),{urls:r,orders:i,codes:a,media:l}}currentUrl(){let e=this.url,t=e.split("/").pop();return{host:e.substring(0,e.length-t.length),filename:t}}async getTextFromFiles(e){if(0==e.length)return[];let t=e.map((e=>fetch(e))),r=await Promise.allSettled(t),l=[];r.map(((e,t)=>{e.value.ok||l.push(t)})),r=r.filter((e=>e.value.ok));let i=r.map((e=>e.value));r=await Promise.all(i);let s=r.map((e=>e.text())),n=await Promise.all(s);return l.map((e=>n.splice(e,0,"error: check your path"))),n}removeComment(e){return e.replace(/<!--[\s\S]*?-->/gm,"")}escapeHtml(e){let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;","(":"&#40;",")":"&#41;"};return e.replace(/[&<>"'()]/g,(function(e){return t[e]}))}removeControlText(e){return e.replaceAll(/\r|\n|\t/g,"")}}onmessage=e=>{let t={},r=e.data.path,l=e.data.scope;(new myWorker).readFurther(l,r).then((e=>{t.fileIncludedHTML=e.fileIncludedHTML,t.cssText=e.cssText,t.fileName=e.filename,t.titleCode=e.titleCode,postMessage(t)}))};