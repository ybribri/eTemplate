class myWorker{constructor({options:t}={}){this.titleCode="",this.openDelimiter=t.openDelimiter,this.closeDelimiter=t.closeDelimiter,this.commentDelimiter=t.openDelimiter+"%",this.url="",this.titleCode="",this.metaArray=[],this.options={titleChange:t.titleChange,metaChange:t.metaChange,cssChange:t.cssChange}}async readFurther(t){let e="";const r=await fetch(t);let s=await r.text();this.options.metaChange&&this.readMeta(s),this.options.titleChange&&this.getTitle(s),this.url=t,this.options.cssChange&&(e=await this.changeCss(s));return{fileIncludedHTML:(await this.insertNestedHTML(s)).fileIncludedHTML,cssText:e,filename:this.currentUrl().filename,titleCode:this.titleCode,metaArray:this.metaArray}}findInclude(t){const e=/< *?body *?>[\s\S]*?< *?\/ *?body>/g,r=/ *?include\( *?["'`](.*?)["'`] *?\)/g,s=/ *?include\( *?["'`]/g,l=/["'`] *?\).*/g,i=null===t.match(e)?t:t.match(e)[0].replace(/< *?body *?>/g,"").replace(/< *?\/ *?body *?>/g,""),{codes:n,types:a}=this.seperateCode(i,"first"),o=a.length,h=this.currentUrl().host;let c=[],u=[],p=0;for(let t=0;t<o;t++)if("JS"==a[t]&&r.test(n[t])){const e=n[t].match(r)[0].replace(s,"").replace(l,"");c.push(new URL(e,h).href),u[p]=t,p++}return{urls:c,orders:u,codeList:n}}async insertNestedHTML(t,e=[]){let r="",{urls:s,orders:l,codeList:i}=this.findInclude(t,e);if(0==s.length)return r=this.removeComment(i.join("")),{fileIncludedHTML:r,codeList:i};let n=[];s.forEach((t=>n.push(this.getComparedPath(t,this.currentUrl().host))));let a=await this.getTextFromFiles(s);for(let t=0;t<a.length;t++)a[t]=this.htmlReplaceRelativeUrl(a[t],n[t]);return a.forEach(((t,e)=>i[l[e]]=t)),r=this.removeComment(i.join("")),await this.insertNestedHTML(r,n)}seperateCode(t,e){const r=`(${this.openDelimiter}[^%][\\s\\S]*?${this.closeDelimiter})`,s=new RegExp(r,"g");let l=t.split(s),i=[];const n=l.length;for(let t=0;t<n;t++){const r=l[t],n=s.test(r)?"JS":"HTML";l[t]="JS"===n&&"second"===e?r.substring(2,r.length-2).trim():r,i.push(n)}const a=i.length;if(a>1)for(let t=a-1;t>=1;t--)i[t]==i[t-1]&&"HTML"==i[t]&&(l[t-1]=l[t-1]+l[t],l.splice(t,1),i.splice(t,1));return{types:i,codes:l}}getTitle(t){const e=/<head>[\s\S]*?<\/head>/g,r=/<title>[\s\S]*?<\/title>/g,s=null==t.match(e)?"":t.match(e)[0],l=null==s.match(r)?"":s.match(r)[0].replace("<title>","").replace("</title>","").trim();this.titleCode=l.length>0?l:this.titleCode}readMeta(t){const e=`\\<meta[\\s\\S]*?[^${this.closeDelimiter}]\\>`,r=new RegExp(e,"g"),s=/([\w|\-|\_]*) *= *((['"])?((\\\3|[^\3])*?)\3|(\w+))/g,l=[...t.matchAll(r)];let i=[];l.forEach(((t,e)=>{let r=[...t[0].matchAll(s)];for(let t=0;t<r.length;t++)r[t][4].indexOf(this.openDelimiter)>-1&&i.push({metaNo:e,attributeNo:t,nodeName:r[t][1],nodeValue:r[t][4]})})),this.metaArray=JSON.parse(JSON.stringify(i))}async changeCss(t){t=this.removeComment(t);let e=await this.combineCss(t);return e=this.changeNestingPattern(e),e}async combineCss(t){let e=[],r=[];const s=t.indexOf("<head>"),l=t.indexOf("</head>");if(-1==s||-1==l)return"";t.replace(/<style>[\s\S]*?<\/style>/gi,(function(t){return r.push(t.replaceAll("<style>","").replaceAll("</style>","")),""}));let i=r.join(""),n=[];t.replace(/<link.*?rel="stylesheet"[\s\S]*?\/?>/gi,(function(t){return n.push(t),""}));const a=this.currentUrl().host;n.forEach((t=>{let r=t.match(/href=".*?"/gi)[0].replaceAll("href=","").replaceAll('"',"");r.indexOf("http")<0&&e.push(new URL(r,a).href)}));let o=await this.getTextFromFiles(e),h=[];e.forEach((t=>{h.push(this.getComparedPath(t,this.currentUrl().host))}));for(let t=0;t<o.length;t++)o[t]=this.replaceRelativeUrl(o[t],h[t]);return i+=o.join(""),i=await this.insertNestedCSS(i),i}getOnlyPath(t){let e=t.split("/");return e.pop(),e.join("/")}splitUrl(t){let e=t.split("/");return""==e[e.length-1]&&e.pop(),""==e[0]&&e.shift(),e}getRelativeUrl(t){const e=this.currentUrl().host,r=this.splitUrl(e);let s=this.splitUrl(t),l=[];for(let t=0;t<r.length;t++)r[t]!==s[t]?l.push(".."):s[t]=".";s=[...l,...s];for(let t=0;t<s.length;t++)"."==s[t]&&"."==s[t+1]&&(s[t]="_erase_");for(let t=s.length-1;t>=0;t--)("_erase_"==s[t]||"."==s[t]&&t>0)&&s.splice(t,1);return"/"+s.join("/")+"/"}getComparedPath(t,e){t=this.getOnlyPath(t),t=this.getRelativeUrl(t),e=this.getRelativeUrl(e);let r=this.splitUrl(t),s=this.splitUrl(e),l=[];for(let t=0;t<s.length;t++)s[t]!==r[t]?""!==s[t]&&l.push(".."):r[t]=".";return r=[...l,...r],r.join("/")+"/"}replaceRelativeUrl(t,e){function r(t,r,s,l,i,n,a){return null==r?i+(n=this.compareUrls(n,e))+a:r+(s=this.compareUrls(s,e))+l}if(r=r.bind(this),t.includes("base64,")||t.includes("http"))return t;return t.replace(/(@import *['"])(.*?)(['"])|(url\(['"]?)(.*?)(['"]?\))/g,r)}htmlReplaceRelativeUrl(t,e){function r(t,r,s,l,i,n,a,o,h,c){return void 0!==r?r+(s=this.compareUrls(s,e))+l:void 0!==i?i+(n=this.compareUrls(n,e))+a:o+(h=this.compareUrls(h,e))+c}return r=r.bind(this),t.replace(/(\<[a-z]* *src *= *['"`])((?!http|\<\%).*)(['"`])|(href *= *['"`])((?!http|\<\%|#).*[^\>\%])(['"`])|(\<\%[^\%] *include *\(?["'`])(.*)(["'`])/g,r)}compareUrls(t,e){if(!t.includes("/"))return e+t;if("/"==t.substring(0,1))return e+t.substring(1);if("./"==t.substring(0,2))return e+t.substring(2);if("../"==t.substring(0,3)){let r=e.split("/");return r.pop(),r.pop(),(e="."+r.join("/")+"/")+t.substring(3)}}async insertNestedCSS(t){let{urls:e,orders:r,codes:s,media:l}=this.findImport(t);if(0==e.length)return s.join("");let i=await this.getTextFromFiles(e),n=[];e.forEach((t=>{n.push(this.getComparedPath(t,this.currentUrl().host))}));for(let t=0;t<i.length;t++)i[t]=this.replaceRelativeUrl(i[t],n[t]);return i.forEach(((t,e)=>{s[r[e]]=""!==l[e]?this.insertMedia(t,l[e]):t})),await this.insertNestedCSS(s.join(""))}insertMedia(t,e){return`@media ${e} { ${t} }`}findImport(t){const e=/(@import *?(?:url)?\(?["'].*["']\)? *?.*;)/g,r=/[^(?:\.)|(?:\.\/)].*/g;let s=[],l=[],i=[],n=0,a=t.split(e);const o=[...t.matchAll(/@import *?(url)?\(?["'](.*)["']\)? *?(.*);/g)];for(let t=0;t<a.length;t++)-1==a[t].search(e)||a[t].includes("http")?a[t]=this.removeControlText(a[t]).trim():(i[n]=t,n++);return o.forEach((t=>{const e=t[2].match(r)[0].trim();s.push(this.currentUrl().host+e),l.push(null===t[3]?"":t[3].trim())})),{urls:s,orders:i,codes:a,media:l}}changeNestingPattern(t){let e=this.getStyle(t);return e=this.getSub(e),this.makeStyle(e)}makeStyle(t){let e="";for(let r=0;r<t.length;r++)e+=`${t[r].selector} {\n ${t[r].styleText}\n}\n`;return e}getSub(t){let e=!1;for(let r=t.length-1;r>=0;r--){if(Array.isArray(t[r].styleText)){t[r].styleText=this.makeStyle(this.getSub(t[r].styleText));continue}let s=t[r].styleText;const l=this.getInfo(s);for(let i=l.length-1;i>=0;i--){let n=s.substring(l[i].selectorStart,l[i].selectorEnd+1).trim();n=n.replaceAll("&",t[r].selector);const a=s.substring(l[i].styleStart+1,l[i].styleEnd).trim(),o=s.substring(l[i].selectorStart,l[i].styleEnd+1);t.splice(r+1,0,{selector:n,styleText:a}),s=s.replace(o,""),e=!0}t[r].styleText=s}return e?this.getSub(t):t}getInfo(t){let e=[],r=-1,s=-1,l=-1,i=-1,n=0;for(let a=0;a<t.length;a++){const o=n,h=t[a];-1===r&&"&"===h&&(r=a),-1!==r&&"{"===h&&(-1===l&&(l=a,s=a-1),n++),-1!==l&&"}"===h&&n--,n!==o&&0===n&&(i=a,e.push({selectorStart:r,selectorEnd:s,styleStart:l,styleEnd:i}),r=-1,s=-1,l=-1,i=-1)}return e}getStyle(t){let e=[],r="",s="",l=0,i=0;const n=new Map([["{",1],["}",-1]]);for(let a=0;a<t.length;a++){const o=t[a];i=l,l+=void 0===n.get(o)?0:n.get(o),s+=o,i!==l&&0===l&&(r.includes("@media")||r.includes("@supports")?e.push({selector:r,styleText:this.getStyle(s.substring(0,s.length-1).trim())}):e.push({selector:r,styleText:s.substring(0,s.length-1).trim()}),s="",r=""),0===i&&1===l&&(r=s.substring(0,s.length-1).trim(),s="")}return e}currentUrl(){const t=this.url,e=t.split("/").pop();return{host:t.substring(0,t.length-e.length),filename:e}}async getTextFromFiles(t){if(0==t.length)return[];const e=t.map((t=>fetch(t)));let r=await Promise.allSettled(e),s=[];r.map(((t,e)=>{t.value.ok||s.push(e)})),r=r.filter((t=>t.value.ok));const l=r.map((t=>t.value));r=await Promise.all(l);const i=r.map((t=>t.text()));let n=await Promise.all(i);return s.map((t=>n.splice(t,0,"error: check your path"))),n}removeComment(t){return t.replace(/<!--[\s\S]*?-->/gm,"")}escapeHtml(t){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;","(":"&#40;",")":"&#41;"};return t.replace(/[&<>"'()]/g,(function(t){return e[t]}))}removeControlText(t){return t.replaceAll(/\r|\n|\t/g,"")}}onmessage=t=>{let e={};const r=t.data.path,s=t.data.options;new myWorker({options:s}).readFurther(r).then((t=>{e.fileIncludedHTML=t.fileIncludedHTML,e.cssText=t.cssText,e.fileName=t.filename,e.titleCode=t.titleCode,e.metaArray=t.metaArray,postMessage(e)}))};