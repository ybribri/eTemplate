class myWorker{constructor({openDelimiter:e="<%",closeDelimiter:t="%>"}={}){this.titleCode="",this.openDelimiter=e,this.closeDelimiter=t,this.commentDelimiter=e+"%",this.url=""}async readFurther(e,t){let i="";const s=await fetch(t);let l=await s.text();this.getTitle(l),this.url=t,"body"!==e&&(i=await this.changeCss(l));return{fileIncludedHTML:(await this.insertNestedHTML(l)).fileIncludedHTML,cssText:i,filename:this.currentUrl().filename,titleCode:this.titleCode}}findInclude(e){let t=[],i=[],s=[],l="",r=0,n="",o=e.indexOf("<body>"),c=e.indexOf("</body>");n=-1==o||-1==c?e:e.substring(o+6,c);let{codes:a,types:h}=this.seperateCode(n,"first"),d=h.length;for(let e=0;e<d;e++)"JS"==h[e]&&-1!=a[e].search(/include\(.*\)/g)&&(t.push(a[e]),s[r]=e,r++);return 0!=t.length&&t.forEach((e=>{e.includes("include(")&&(o=e.indexOf('include("'),-1==o?o=e.indexOf("include('")+9:o+=9,c=e.indexOf('")'),-1==c&&(c=e.indexOf("')")),l=e.substring(o,c),l="/"==l.substring(0,1)?l.substring(1):l,l="./"==l.substring(0,2)?l.substring(2):l,i.push(this.currentUrl().host+l))})),{urls:i,orders:s,codeList:a}}async insertNestedHTML(e){let t="",{urls:i,orders:s,codeList:l}=this.findInclude(e);return 0==i.length?(t=l.join(""),{fileIncludedHTML:t,codeList:l}):((await this.getTextFromFiles(i)).forEach(((e,t)=>{l[s[t]]=e})),t=l.join(""),({urls:i,orders:s,codeList:l}=this.findInclude(t)),0==i.length||({fileIncludedHTML:t,codeList:l}=await this.insertNestedHTML(t)),{fileIncludedHTML:t,codeList:l})}insertModules(e){let{types:t,codes:i}=this.seperateCode(e,"first"),s=0,l=t.length;for(let e=0;e<l;e++)if("JS"==t[e]&&i[e].includes("<%#")){let t=i[e].match(/(?<=<%#).*(?=%>)/)[0];try{i[e]=this.basicCode(t),s++}catch{i[e]='<%= "invalid module" %>',s++}}let r=i.join("");return 0!==s&&(r=this.insertModules(r)),r}seperateCode(e,t){const i=`(${this.openDelimiter}[^%].*?${this.closeDelimiter})`,s=new RegExp(i,"g");let l=e.split(s),r=[],n=l.length;for(let e=0;e<n;e++){let i=l[e],s=i.indexOf(`${this.openDelimiter}`),n=i.indexOf(`${this.closeDelimiter}`),o="";0!=s||n!=i.length-2||i.includes("closeDelimiter:")?o="HTML":(o="JS",l[e]="second"==t?i.substring(2,i.length-2).trim():i),r.push(o)}let o=r.length;if(o>1)for(let e=o-1;e>=1;e--)r[e]==r[e-1]&&"HTML"==r[e]&&(l[e-1]=l[e-1]+l[e],l.splice(e,1),r.splice(e,1));return{types:r,codes:l}}getTitle(e){const t=e.match(/<head>(.|[\t\n\r])*?<\/head>/g)[0].match(/<title>(.|[\t\n\r])*?<\/title>/g)[0].replace("<title>","").replace("</title>","").trim();this.titleCode=t.length>0?t:this.titleCode}async changeCss(e){return await this.combineCss(e)}async combineCss(e){let t=[],i=[],s=e.indexOf("<head>"),l=e.indexOf("</head>");if(-1==s||-1==l)return"";e.replace(/<style>(.|[\t\n\r])*?<.style>/gi,(function(e){return i.push(e.replaceAll("<style>","").replaceAll("</style>","")),""}));let r=i.join(""),n=[];e.replace(/<link.*?(rel=("|')stylesheet("|')).*?>/gi,(function(e){return n.push(e),""}));let o=this.currentUrl().host;return n.forEach((e=>{let i=e.match(/href=".*?"/gi)[0].replaceAll("href=","").replaceAll('"',"");i.includes("http")||t.push(o+i)})),r=(await this.getTextFromFiles(t)).reduce(((e,t)=>e+t),r),r=await this.insertNestedCSS(r),r}async insertNestedCSS(e){let t="",{urls:i,orders:s,codes:l}=this.findImport(e);return 0==i.length?(t=l.join(""),t):((await this.getTextFromFiles(i)).forEach(((e,t)=>{l[s[t]]=e})),t=l.join(""),({urls:i,orders:s,codes:l}=this.findImport(t)),0!=i.length?(t=await this.insertNestedCSS(t),t):t)}findImport(e){let t=[],i=[],s=[],l="",r=0;const n=/@import[\s\S]*?["|'].*?["|'];/g;let{types:o,codes:c}=this.seperateImport(e);for(let e=0;e<o.length;e++)"IMPORT"!=o[e]||-1==c[e].search(n)||c[e].includes("http")||(t.push(c[e]),s[r]=e,r++);return 0!=t.length&&t.forEach((e=>{l=e.match(n)[0].replaceAll("@import","").replaceAll('"',"").replaceAll(";","\n").trim(),l="/"==l.substring(0,1)?l.substring(1):l,l="./"==l.substring(0,2)?l.substring(2):l,i.push(this.currentUrl().host+l)})),{urls:i,orders:s,codes:c}}seperateImport(e){let t=e.split(/(@import *["|'].*?["|'];)/g),i=[],s=t.length;for(let e=0;e<s;e++){let s=t[e],l=s.includes("@import")?"IMPORT":"OTHER";i.push(l),t[e]=s.includes("@import")?s.trim():this.removeControlText(s).trim()}return{types:i,codes:t}}currentUrl(){let e=this.url,t=e.split("/").pop();return{host:e.substring(0,e.length-t.length),filename:t}}async getTextFromFiles(e){if(0==e.length)return[];let t=e.map((e=>fetch(e))),i=await Promise.allSettled(t),s=[];i.map(((e,t)=>{e.value.ok||s.push(t)})),i=i.filter((e=>e.value.ok));let l=i.map((e=>e.value));i=await Promise.all(l);let r=i.map((e=>e.text())),n=await Promise.all(r);return s.map((e=>n.splice(e,0,"error: check your path"))),n}escapeHtml(e){let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;","(":"&#40;",")":"&#41;"};return e.replace(/[&<>"'()]/g,(function(e){return t[e]}))}removeControlText(e){return e.replaceAll(/\r|\n|\t/g,"")}}onmessage=e=>{let t={},i=e.data.path,s=e.data.iScope;(new myWorker).readFurther(s,i).then((e=>{t.fileIncludedHTML=e.fileIncludedHTML,t.cssText=e.cssText,t.fileName=e.filename,t.titleCode=e.titleCode,postMessage(t)}))};