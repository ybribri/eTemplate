class myWorker{constructor({options:e}={}){this.titleCode="",this.openDelimiter=e.openDelimiter,this.closeDelimiter=e.closeDelimiter,this.commentDelimiter=e.openDelimiter+"%",this.url="",this.titleCode="",this.metaArray=[],this.options={titleChange:e.titleChange,metaChange:e.metaChange,cssChange:e.cssChange}}async readFurther(e){let t="";const r=await fetch(e);let i=await r.text();this.options.metaChange&&this.readMeta(i),this.options.titleChange&&this.getTitle(i),this.url=e,this.options.cssChange&&(t=await this.changeCss(i));return{fileIncludedHTML:(await this.insertNestedHTML(i)).fileIncludedHTML,cssText:t,filename:this.currentUrl().filename,titleCode:this.titleCode,metaArray:this.metaArray}}findInclude(e){const t=/< *?body *?>[\s\S]*?< *?\/ *?body>/g,r=/ *?include\( *?["'`](.*?)["'`] *?\)/g,i=/ *?include\( *?["'`]/g,l=/["'`] *?\).*/g;let s=[],n=[],a="",h=0,o="";o=null===e.match(t)?e:e.match(t)[0].replace(/< *?body *?>/g,"").replace(/< *?\/ *?body *?>/g,"");let{codes:c,types:u}=this.seperateCode(o,"first"),p=u.length,m=this.currentUrl().host;for(let e=0;e<p;e++)"JS"==u[e]&&r.test(c[e])&&(a=c[e].match(r)[0].replace(i,"").replace(l,""),s.push(new URL(a,m).href),n[h]=e,h++);return{urls:s,orders:n,codeList:c}}async insertNestedHTML(e,t=[]){let r="",{urls:i,orders:l,codeList:s}=this.findInclude(e,t);if(0==i.length)return r=this.removeComment(s.join("")),{fileIncludedHTML:r,codeList:s};let n=[];i.forEach(((e,t)=>{n.push(this.getComparedPath(e,this.currentUrl().host))}));let a=await this.getTextFromFiles(i);for(let e=0;e<a.length;e++)a[e]=this.htmlReplaceRelativeUrl(a[e],n[e]);return a.forEach(((e,t)=>{s[l[t]]=e})),r=this.removeComment(s.join("")),await this.insertNestedHTML(r,n)}seperateCode(e,t){const r=`(${this.openDelimiter}[^%][\\s\\S]*?${this.closeDelimiter})`,i=new RegExp(r,"g");let l=e.split(i),s=[],n=l.length;for(let e=0;e<n;e++){let r=l[e],n=i.test(r)?"JS":"HTML";l[e]="JS"===n&&"second"===t?r.substring(2,r.length-2).trim():r,s.push(n)}let a=s.length;if(a>1)for(let e=a-1;e>=1;e--)s[e]==s[e-1]&&"HTML"==s[e]&&(l[e-1]=l[e-1]+l[e],l.splice(e,1),s.splice(e,1));return{types:s,codes:l}}getTitle(e){const t=/<head>[\s\S]*?<\/head>/g,r=/<title>[\s\S]*?<\/title>/g,i=null==e.match(t)?"":e.match(t)[0],l=null==i.match(r)?"":i.match(r)[0].replace("<title>","").replace("</title>","").trim();this.titleCode=l.length>0?l:this.titleCode}readMeta(e){const t=`\\<meta[\\s\\S]*?[^${this.closeDelimiter}]\\>`,r=new RegExp(t,"g"),i=/([\w|\-|\_]*) *= *((['"])?((\\\3|[^\3])*?)\3|(\w+))/g,l=[...e.matchAll(r)];let s=[];l.forEach(((e,t)=>{let r=[...e[0].matchAll(i)];for(let e=0;e<r.length;e++)r[e][4].indexOf(this.openDelimiter)>-1&&s.push({metaNo:t,attributeNo:e,nodeName:r[e][1],nodeValue:r[e][4]})})),this.metaArray=JSON.parse(JSON.stringify(s))}async changeCss(e){return e=this.removeComment(e),await this.combineCss(e)}async combineCss(e){let t=[],r=[],i=e.indexOf("<head>"),l=e.indexOf("</head>");if(-1==i||-1==l)return"";e.replace(/<style>[\s\S]*?<\/style>/gi,(function(e){return r.push(e.replaceAll("<style>","").replaceAll("</style>","")),""}));let s=r.join(""),n=[];e.replace(/<link.*?rel="stylesheet"[\s\S]*?\/?>/gi,(function(e){return n.push(e),""}));let a=this.currentUrl().host;n.forEach((e=>{let r=e.match(/href=".*?"/gi)[0].replaceAll("href=","").replaceAll('"',"");r.indexOf("http")<0&&t.push(new URL(r,a).href)}));let h=await this.getTextFromFiles(t),o=[];t.forEach((e=>{o.push(this.getComparedPath(e,this.currentUrl().host))}));for(let e=0;e<h.length;e++)h[e]=this.replaceRelativeUrl(h[e],o[e]);return s+=h.join(""),s=await this.insertNestedCSS(s),s}getOnlyPath(e){let t=e.split("/");return t.pop(),t.join("/")}splitUrl(e){let t=e.split("/");return""==t[t.length-1]&&t.pop(),""==t[0]&&t.shift(),t}getRelativeUrl(e){let t=this.currentUrl().host,r=this.splitUrl(e),i=this.splitUrl(t),l=[];for(let e=0;e<i.length;e++)i[e]!==r[e]?l.push(".."):r[e]=".";r=[...l,...r];for(let e=0;e<r.length;e++)"."==r[e]&&"."==r[e+1]&&(r[e]="_erase_");for(let e=r.length-1;e>=0;e--)("_erase_"==r[e]||"."==r[e]&&e>0)&&r.splice(e,1);return"/"+r.join("/")+"/"}getComparedPath(e,t){e=this.getOnlyPath(e),e=this.getRelativeUrl(e),t=this.getRelativeUrl(t);let r=this.splitUrl(e),i=this.splitUrl(t),l=[];for(let e=0;e<i.length;e++)i[e]!==r[e]?""!==i[e]&&l.push(".."):r[e]=".";return r=[...l,...r],r.join("/")+"/"}replaceRelativeUrl(e,t){function r(e,t){if(!e.includes("/"))return t+e;if("/"==e.substring(0,1))return t+e.substring(1);if("./"==e.substring(0,2))return t+e.substring(2);if("../"==e.substring(0,3)){let r=t.split("/");return r.pop(),r.pop(),(t="."+r.join("/")+"/")+e.substring(3)}}if(e.includes("base64,")||e.includes("http"))return e;return e.replace(/(@import *['"])(.*?)(['"])|(url\(['"]?)(.*?)(['"]?\))/g,(function(e,i,l,s,n,a,h){return null==i?n+(a=r(a,t))+h:i+(l=r(l,t))+s}))}htmlReplaceRelativeUrl(e,t){function r(e,t){if(!e.includes("/"))return t+e;if("/"==e.substring(0,1))return t+e.substring(1);if("./"==e.substring(0,2))return t+e.substring(2);if("../"==e.substring(0,3)){let r=t.split("/");return r.pop(),r.pop(),(t="."+r.join("/")+"/")+e.substring(3)}}return e.replace(/(\<[a-z]* *src *= *['"`])((?!http|\<\%).*)(['"`])|(href *= *['"`])((?!http|\<\%|#).*[^\>\%])(['"`])|(\<\%[^\%] *include *\(?["'`])(.*)(["'`])/g,(function(e,i,l,s,n,a,h,o,c,u){return void 0!==i?i+(l=r(l,t))+s:void 0!==n?n+(a=r(a,t))+h:o+(c=r(c,t))+u}))}async insertNestedCSS(e){let t="",{urls:r,orders:i,codes:l,media:s}=this.findImport(e);if(0==r.length)return t=l.join(""),t;let n=await this.getTextFromFiles(r),a=[];r.forEach((e=>{a.push(this.getComparedPath(e,this.currentUrl().host))}));for(let e=0;e<n.length;e++)n[e]=this.replaceRelativeUrl(n[e],a[e]);return n.forEach(((e,t)=>{l[i[t]]=""!==s[t]?this.insertMedia(e,s[t]):e})),t=l.join(""),await this.insertNestedCSS(t)}insertMedia(e,t){return`@media ${t} { ${e} }`}findImport(e){let t=[],r=[],i=[],l=[],s="",n=0;const a=/(@import *?(?:url)?\(?["'].*["']\)? *?.*;)/g,h=/[^(?:\.)|(?:\.\/)].*/g;let o=e.split(a);t=[...e.matchAll(/@import *?(url)?\(?["'](.*)["']\)? *?(.*);/g)];for(let e=0;e<o.length;e++)-1==o[e].search(a)||o[e].includes("http")?o[e]=this.removeControlText(o[e]).trim():(l[n]=e,n++);return t.forEach((e=>{s=e[2].match(h)[0].trim(),r.push(this.currentUrl().host+s),i.push(null===e[3]?"":e[3].trim())})),{urls:r,orders:l,codes:o,media:i}}currentUrl(){let e=this.url,t=e.split("/").pop();return{host:e.substring(0,e.length-t.length),filename:t}}async getTextFromFiles(e){if(0==e.length)return[];let t=e.map((e=>fetch(e))),r=await Promise.allSettled(t),i=[];r.map(((e,t)=>{e.value.ok||i.push(t)})),r=r.filter((e=>e.value.ok));let l=r.map((e=>e.value));r=await Promise.all(l);let s=r.map((e=>e.text())),n=await Promise.all(s);return i.map((e=>n.splice(e,0,"error: check your path"))),n}removeComment(e){return e.replace(/<!--[\s\S]*?-->/gm,"")}escapeHtml(e){let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;","(":"&#40;",")":"&#41;"};return e.replace(/[&<>"'()]/g,(function(e){return t[e]}))}removeControlText(e){return e.replaceAll(/\r|\n|\t/g,"")}}onmessage=e=>{let t={},r=e.data.path,i=e.data.options;new myWorker({options:i}).readFurther(r).then((e=>{t.fileIncludedHTML=e.fileIncludedHTML,t.cssText=e.cssText,t.fileName=e.filename,t.titleCode=e.titleCode,t.metaArray=e.metaArray,postMessage(t)}))};