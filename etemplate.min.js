"use strict";class eTemplate{constructor({openDelimiter:e="<%",closeDelimiter:t="%>",syncClass:s="et_sync",startUrl:l="",urlList:r=[]}={}){this.htmlCode=[],this.htmlType=[],this.htmlSync=[],this.cssRules=[],this.cssCode=[],this.cssType=[],this.syncCnt=0,this.templateInClass=[],this.titleCode="",this.startUrl=l,this.syncClass=s,this.openDelimiter=e,this.closeDelimiter=t,this.commentDelimiter=e+"%",this.preRead=[],this.urlList=r,this.fileName="",this.scripts=[],this.currentHash=""}async render({url:e="",scroll:t={},scope:s=""}={},l=function(){}){this.syncCnt=0,"function"==typeof arguments[0]&&(l=arguments[0]),e=""===e?""!==this.startUrl?this.startUrl:this.currentUrl().filename:e,e=this.verifyFilename(e),this.urlList=this.urlList.map((e=>this.verifyFilename(e)));let r=this.urlList.indexOf(e)||0,i="";if(this.fileName=e,0==this.preRead.length){this.urlList.length>0&&this.preReadFiles(this.urlList,s);let t=this.currentUrl().host+e;const l=await fetch(t),r=await l.text();this.getTitle(r),this.changeTitle(this.titleCode);const n=await this.readFurther(r,s);i=n.htmlBlock.join("")+this.scripts.join(""),this.htmlCode=n.codeList.code,this.htmlType=n.codeList.type}else{let e=this.preRead[r].fileIncludedHTML,t=this.preRead[r].cssText;this.titleCode=this.preRead[r].titleCode,this.templateInClass=[],this.syncCnt=0,this.changeTitle(this.titleCode),"body"!==s&&this.changeCssFromCombinedStyle(t);let l=this.insertModules(e);const n=await this.readFurtherFromCombinedHTML(l);i=n.htmlBlock.join(""),this.htmlCode=n.codeList.code,this.htmlType=n.codeList.type}if(this.removeAllChildNodes(document.querySelector("body")),document.body.insertAdjacentHTML("afterbegin",i),t!={}&&0!=Object.keys(t).length){let e=document.getElementById(t.id),s=["start","center","end"].some((e=>e==t.position));t.position=s?t.position:"center",null!==e&&document.getElementById(t.id).scrollIntoView({block:t.position})}return document.body.style.display="block",l(),new Promise(((e,t)=>{e("done")}))}async preReadFiles(e,t){let s=[];for(let l=0;l<e.length;l++){const r=new URL(e[l],this.currentUrl().host).href;s[l]=new Worker(this.currentUrl().host+"js/worker.min.js"),s[l].postMessage({path:r,scope:t}),s[l].onmessage=e=>{this.preRead[l]=e.data,s[l].terminate()}}}storeScript(e){let t=[];this.scripts=t;let s=e.match(/<body*?>(\n|\r|\t|.)*/gm);return null===s?e:(t=s[0].match(/<script[\s\S]*?>[\s\S]*?<\/script>/gm,""),null===t||(t.forEach((t=>{e=e.replace(t,"")})),this.scripts=t),e)}async readFurther(e,t){e=this.removeComment(e),e=this.storeScript(e),"body"!==t&&await this.changeCss(e);let{fileIncludedHTML:s,codeList:l}=await this.insertNestedHTML(e),r=this.insertModules(s),{types:i,codes:n}=this.seperateCode(r,"second"),c=this.makeSyncBlock(i,n);"JS"==i[0]&&(i.unshift("HTML"),n.unshift(" "),c=c.map((e=>e+1)),c.unshift(0)),l=this.insertSync(i,n,c),this.htmlSync=c,this.syncCnt=l.syncCnt;let h=this.interpret(i,n);return new Promise(((e,t)=>{e({htmlBlock:h,codeList:l})}))}async readFurtherFromCombinedHTML(e){let t=this.insertModules(e),{types:s,codes:l}=this.seperateCode(t,"second"),r=this.makeSyncBlock(s,l);"JS"==s[0]&&(s.unshift("HTML"),l.unshift(" "),r=r.map((e=>e+1)),r.unshift(0));let i=this.insertSync(s,l,r);return this.htmlSync=r,this.syncCnt=i.syncCnt,{htmlBlock:this.interpret(s,l),codeList:i}}sync(e){let t="",s=this.syncClass;new RegExp("${eClass}_");this.changeTitle(this.titleCode);const l=document.querySelectorAll(`input.${s}`);for(let e=0;e<l.length;e++){let s=l[e];if(t="",t=s.getAttribute("data-sync"),null!=t){"number"==s.type?t+="="+(s.value?`${this.escapeHtml(s.value)};`:'"";'):t+="="+(s.value?`"${this.escapeHtml(s.value)}";`:'"";');try{this.controlCode(t)}catch(e){return e}}}let r=this.interpretPart(this.htmlType,this.htmlCode,s);const i=document.querySelectorAll(`.${s}`);for(let e=0;e<i.length;e++){let l=i[e],n=[...l.classList],c=n.find((e=>e.startsWith(s+"_"))),h=void 0!==c?c.split("_").pop().split("+"):[],a=void 0!==c,o=n.find((e=>e.startsWith(s+"Cnt"))),u=void 0!==o?parseInt(o.replace(`${s}Cnt`,""),10):0;if(a)for(let e=0;e<h.length;e++)if("class"==h[e])Array.isArray(r[u])?(0!==this.templateInClass[u].length&&l.classList.remove(this.templateInClass[u][e]),""!==r[u][e]&&l.classList.add(r[u][e]),this.templateInClass[u][e]=r[u][e]):(""!==this.templateInClass[u][e]&&l.classList.remove(this.templateInClass[u][e]),""!==r[u]&&l.classList.add(r[u]),this.templateInClass[u][e]=r[u]);else if(h[e].includes("data-"))if(Array.isArray(r[u])){let s=h[e].substring(h[e].indexOf("data-")+5);t=l.dataset[s],t=t.replace(this.templateInClass[u][e],r[u][e]),l.dataset[s]=t,this.templateInClass[u][e]=r[u][e]}else{let s=h[e].substring(h[e].indexOf("data-")+5);t=l.dataset[s],t=t.replace(this.templateInClass[u][e],r[u]),l.dataset[s]=t,this.templateInClass[u][e]=r[u]}else Array.isArray(r[u])?(t=l.getAttribute(h[e]),t=t.replace(this.templateInClass[u][e],r[u][e]),l.setAttribute(h[e],t),this.templateInClass[u][e]=r[u][e]):(t=l.getAttribute(h[e]),t=t.replace(this.templateInClass[u][e],r[u]),l.setAttribute(h[e],t),this.templateInClass[u][e]=r[u]);else this.removeAllChildNodes(l),l.insertAdjacentHTML("afterbegin",r[u])}"body"!=e&&this.syncCss()}syncCss(){if(0==this.cssType.length||!this.cssType.includes("JS"))return;let e=this.interpret(this.cssType,this.cssCode),t=this.parseCSS(e.join("")),s=0;for(let e=0;e<document.styleSheets.length;e++)if(null==document.styleSheets[e].href){s=e;break}let l=this.cssRules,r=l.length;const i=/\s+|\\n/g;let n="",c=[],h=[],a=t.length;for(let e=0;e<a;e++){let a=t[e],o=null==a.type?"":a.type,u=-1,d=0,p="";switch(o){case"keyframes":for(let e=0;e<r;e++){let t=l[e],s=a.styles.substring(0,a.styles.indexOf("{")).trim(),r=t.styles.substring(0,t.styles.indexOf("{")).trim();if("keyframes"==t.type&&s==r){u=e;break}}if(u>-1){let e=l[u].styles,t=a.styles;e.replace(i,"")!=t.replace(i,"")&&(document.styleSheets[s].deleteRule(u),document.styleSheets[s].insertRule(t,u)),h.push([u,-2,0,7])}else c.push(["rule",e,-1,-1,a.styles]);break;case"media":case"supports":d="media"==o?4:12;for(let e=0;e<r;e++){let t=l[e];if(t.type==o&&a.selector==t.selector){u=e;break}}if(u>-1)a.subStyles.forEach(((t,r)=>{p=t.selector;let i=-1,a=l[u].subStyles.length;for(let e=0;e<a;e++)if(l[u].subStyles[e].selector==p){i=e;break}if(i>-1)t.rules.forEach(((t,n)=>{let a=-1,o=l[u].subStyles[i].rules.length;for(let e=0;e<o;e++){if(l[u].subStyles[i].rules[e].key==t.key){a=e;break}}if(a>-1){let e=l[u].subStyles[i].rules[a].key,r=l[u].subStyles[i].rules[a].value,n=t.value;r!=n&&document.styleSheets[s].cssRules[u].cssRules[i].style.setProperty(e,n),h.push([u,i,a,d])}else c.push(["style",e,r,n,t.key,t.value])}));else{n="    "+t.selector+" {\n";for(let e=0;e<t.rules.length;e++)n+=`        ${t.rules[e].key}: ${t.rules[e].value};\n`;n+="    }\n",c.push(["rule",e,r,-1,n])}}));else{n=a.selector+" {\n";let t=a.subStyles.length;for(let e=0;e<t;e++){let t=a.subStyles[e];n+="    "+t.selector+" {\n";let s=t.rules.length;for(let e=0;e<s;e++)n+=`        ${t.rules[e].key}: ${t.rules[e].value};\n`;n+="    }\n"}n+="}\n",c.push(["rule",e,-1,-1,n])}break;case"":case"font-face":d="font-face"==o?5:1;for(let t=e;t<r;t++){let e=l[t];if(a.selector==e.selector){u=t;break}}if(u>-1){let t=a.rules.length;for(let r=0;r<t;r++){let t=a.rules[r],i=-1,o=l[u].rules.length;for(let e=0;e<o;e++){if(l[u].rules[e].key==t.key){i=e;break}}if(i>-1){let e=l[u].rules[i].key,r=l[u].rules[i].value,n=t.value;r!=n&&document.styleSheets[s].cssRules[u].style.setProperty(e,n),h.push([u,-1,i,d])}else n=`    ${t.key}: ${t.value};\n`,c.push(["style",e,-1,r,t.key,t.value])}}else{n=a.selector+" {\n";let t=a.rules.length;for(let e=0;e<t;e++)n+=`    ${a.rules[e].key}: ${a.rules[e].value};\n`;n+="}\n",c.push(["rule",e,-1,-1,n])}}}let o=0,u=0;for(let e=l.length-1;e>=0;e--){let t=0,r=l[e];switch(r.type){case"media":case"supports":t="media"==r.type?4:12,o=r.subStyles.length;for(let l=o-1;l>=0;l--){u=r.subStyles[l].rules.length;for(let i=u-1;i>=0;i--){if(this.arrayFind(h,[e,l,i,t])<0){let t=r.subStyles[l].rules[i].key;document.styleSheets[s].cssRules[e].cssRules[l].style.removeProperty(t)}}0==document.styleSheets[s].cssRules[e].cssRules[l].style.length&&document.styleSheets[s].cssRules[e].deleteRule(l)}0==document.styleSheets[s].cssRules[e].cssRules.length&&document.styleSheets[s].deleteRule(e);break;case"":case"font-face":t=""==r.type?1:5,u=r.rules.length;for(let l=u-1;l>=0;l--){if(this.arrayFind(h,[e,-1,l,t])<0){let t=r.rules[l].key;document.styleSheets[s].cssRules[e].style.removeProperty(t)}}0==document.styleSheets[s].cssRules[e].style.length&&document.styleSheets[s].deleteRule(e);break;case 7:this.arrayFind(h,[e,-2,0,7])<0&&document.styleSheets[s].deleteRule(e)}}let d=c.length;for(let e=0;e<d;e++){let[t,l,r,i,n,h=""]=c[e];"style"==t?-1==r?document.styleSheets[s].cssRules[l].style.setProperty(n,h):document.styleSheets[s].cssRules[l].cssRules[r].style.setProperty(n,h):-1==r?document.styleSheets[s].insertRule(n,l):document.styleSheets[s].cssRules[l].insertRule(n,r)}this.cssRules=JSON.parse(JSON.stringify(t))}findInclude(e){const t=/< *?body *?>[\s\S]*?< *?\/ *?body>/g,s=/ *?include\( *?["'`](.*?)["'`] *?\)/g,l=/ *?include\( *?["'`]/g,r=/["'`] *?\).*/g;let i=[],n=[],c="",h=0,a="";a=null===e.match(t)?e:e.match(t)[0].replace(/< *?body *?>/g,"").replace(/< *?\/ *?body *?>/g,"");let{codes:o,types:u}=this.seperateCode(a,"first"),d=u.length,p=this.currentUrl().host;for(let e=0;e<d;e++)"JS"==u[e]&&s.test(o[e])&&(c=o[e].match(s)[0].replace(l,"").replace(r,""),i.push(new URL(c,p).href),n[h]=e,h++);return{urls:i,orders:n,codeList:o}}async insertNestedHTML(e,t=[]){let s="",{urls:l,orders:r,codeList:i}=this.findInclude(e,t);if(0==l.length)return s=this.removeComment(i.join("")),{fileIncludedHTML:s,codeList:i};let n=[];l.forEach(((e,t)=>{n.push(this.getComparedPath(e,this.currentUrl().host))}));let c=await this.getTextFromFiles(l);for(let e=0;e<c.length;e++)c[e]=this.htmlReplaceRelativeUrl(c[e],n[e]);return c.forEach(((e,t)=>{i[r[t]]=e})),s=this.removeComment(i.join("")),({urls:l,orders:r,codeList:i}=this.findInclude(s,n)),0==l.length||({fileIncludedHTML:s,codeList:i}=await this.insertNestedHTML(s,n)),{fileIncludedHTML:s,codeList:i}}insertModules(e){const t=/<%#.*?%>/g,s=/<%# */g,l=/ *%>/g;let{types:r,codes:i}=this.seperateCode(e,"first"),n=0,c=r.length;for(let e=0;e<c;e++)if("JS"==r[e]&&i[e].includes("<%#")){let r=" "+i[e].match(t)[0].replace(s,"").replace(l,"");try{i[e]=this.basicCode(r),n++}catch{i[e]='<%= "invalid module" %>',n++}}let h=i.join("");return 0!==n&&(h=this.insertModules(h)),h}seperateCode(e,t){const s=`(${this.openDelimiter}[^%][\\s\\S]*?${this.closeDelimiter})`,l=new RegExp(s,"g");let r=e.split(l),i=[],n=r.length;for(let e=0;e<n;e++){let s=r[e],n=l.test(s)?"JS":"HTML";r[e]="JS"===n&&"second"===t?s.substring(2,s.length-2).trim():s,i.push(n)}let c=i.length;if(c>1)for(let e=c-1;e>=1;e--)i[e]==i[e-1]&&"HTML"==i[e]&&(r[e-1]=r[e-1]+r[e],r.splice(e,1),i.splice(e,1));return{types:i,codes:r}}interpret(e,t){let s=[],l=0,r=this.escapeHtml(this.commentDelimiter.replace(this.commentDelimiter,this.openDelimiter)),i=this.escapeHtml(this.closeDelimiter),n=t.length;for(;l<n;){switch(e[l]){case"HTML":s.push(t[l].replaceAll(this.commentDelimiter,r).replaceAll(this.closeDelimiter,i));break;case"JS":if(0==t[l].search(/=|-/g)){try{s.push(this.basicCode(t[l]))}catch(e){s.push("invalid template")}break}{let r=this.eachBlock(e,t,l);l=r.index;try{s.push(this.controlCode(r.partBlock))}catch(e){s.push("invalid template")}break}}l++}return s}interpretPart(e,t,s){let l=[],r="",i=[],n=[],c="",h=0,a=0,o=0,u=0,d=this.escapeHtml(this.commentDelimiter.replace(this.commentDelimiter,this.openDelimiter)),p=this.escapeHtml(this.closeDelimiter);const m=/(-|[a-z])+ *= *["']/g;let y=t.length;for(h=0;h<y;h++)if("HTML"==e[h]&&(a=0,r="",c=this.removeControlText(t[h]).split("<").pop(),c.includes("class=")&&c.includes(s)&&(r=c.substring(0,c.indexOf(" ")).trim()),r.length>0))for(o=this.htmlSync[h+1],a=h+1;a<t.length&&this.htmlSync[a]==o;a++)i.push(e[a]),n.push(t[a]);let f=n.length,g=0;for(;u<f;){switch(i[u]){case"HTML":null==n[u].match(m)?l.push(n[u].replaceAll(this.commentDelimiter,d).replaceAll(this.closeDelimiter,p)):g=1;break;case"JS":if(0==g){if(0==n[u].search(/=|-/g)){try{l.push(this.basicCode(n[u]))}catch(e){l.push("invalid template script")}break}{let e=this.eachBlock(i,n,u);u=e.index;try{l.push(this.controlCode(e.partBlock))}catch(e){l.push("invalid template script")}break}}if(0==n[u].search(/=|-/g)){try{Array.isArray(l[l.length-1])?l[l.length-1].push(this.basicCode(n[u])):l[l.length-1]=[l[l.length-1],this.basicCode(n[u])]}catch(e){l.push("invalid template script")}g=0;break}{let e=this.eachBlock(i,n,u);u=e.index;try{l.push(this.controlCode(e.partBlock))}catch(e){l.push("invalid template script")}g=0;break}}u++}return l}makeSyncBlock(e,t){let s=[],l=0,r=0,i=0,n=t.length;for(let c=0;c<n;c++){switch(e[c]){case"HTML":s.push(l);break;case"JS":if(0==t[c].search(/=|-/g)){s.push(l);break}r=this.findBlockEnd(e,t,c).index,i=this.findBlockEnd(e,t,c).braceBalance,i<0?console.log("ERROR: missing {"):i>0&&console.log("ERROR: missing }"),s=[...s,...Array(r-c+1).fill(l)],c=r}l++}return s}findBlockEnd(e,t,s){let l=0,r=0,i=t.length;for(r=s;r<i;r++)if(r!=s||"JS"!=e[r]){if("HTML"!=e[r]&&"JS"==e[r]&&0!==t[r].search(/=|-/g)&&(t[r].includes("{")&&l++,t[r].includes("}")&&l--,0==l))return{index:r,error:0}}else if(t[r].includes("{")&&l++,t[r].includes("}")&&l--,0==l)return{index:r,error:0};return 0!=l?{index:s,braceBalance:l}:{index:r,braceBalance:l}}eachBlock(e,t,s){let l="",r=0,i=t.length,n=0;for(n=s;n<i;n++){if(n==s){if("JS"==e[n]){if(t[n].includes("{")&&r++,t[n].includes("}")&&r--,0==r)return{partBlock:t[n],index:n};l=`let eTemplateInterpreted=''; ${t[n]}`;continue}l=`let eTemplateInterpreted='${t[n]}';`}switch(e[n]){case"HTML":""!==this.removeControlText(t[n]).trim()&&(l+=`eTemplateInterpreted += '${t[n]}';`);continue;case"JS":if(0==t[n].search(/=|-/g))l+=`eTemplateInterpreted += ${t[n].substring(1)};`;else if(l+=t[n],t[n].includes("{")&&r++,t[n].includes("}")&&r--,0==r)return l+="; return eTemplateInterpreted;",{partBlock:l,index:n}}}return l+="; return eTemplateInterpreted;",{partBlock:l,index:n}}insertSync(e,t,s){let l=-1,r=0,i=0,n=0,c="",h="",a="",o=0,u=0,d=0,p=[],m=this.syncCnt,y=s.length;const f=this.syncClass,g=/[\s]+((-|[a-z])+) *= *["']/g,C=/[\s\S]+class[\s]*= *["']/g;for(let S=0;S<y;S++)if("JS"==e[S]&&(t[S]=t[S].trim()),s[S]!=l&&"JS"==e[S]){l=s[S],d=0,o=S,u=s.lastIndexOf(s[o]),a=t[S-1],p=[];let b=this.removeControlText(a),T=b.length-b.trimEnd().length;if(">"!=b.substring(b.length-T-1).trim())if(i=a.lastIndexOf(">"),r=a.lastIndexOf("<"),i<r){for(let l=S+1;l<y;l++)if("HTML"===e[l]&&t[l].indexOf(">")>0){for(let e=S+1;e<l;e++)s[e]=s[S];u=s.lastIndexOf(s[S]);break}let l=-1;for(let s=S-1;s<=u;s++)if("HTML"===e[s]&&null!==t[s].match(g)&&"JS"==e[s+1]){let e=[...t[s].matchAll(g)];p.push(e[e.length-1][1]),"class"===p[p.length-1]&&(l=s)}if(l!==S-1&&p.includes("class")){let e=p.indexOf("class");c=p[0],p[0]="class",p[e]=c;let s=t[S],r=t[S-1].lastIndexOf(p[e]),i=t[S+1].indexOf('"'),n=t[S-1].substring(0,r),h=t[S-1].substring(r),a=t[S+1].substring(0,i+1),o=t[S+1].substring(i+1),u=t[l+1],d=t[l].lastIndexOf("class"),m=t[l+2].indexOf('"'),y=t[l].substring(0,d),f=t[l].substring(d),g=t[l+2].substring(0,m+1),C=t[l+2].substring(m+1);t[S]=u,t[l+1]=s,S+1==l?(t[S-1]=n+f,t[S+1]=g+h,t[l+2]=a+C):(t[S-1]=n+f,t[S+1]=g+o,t[l]=y+h,t[l+2]=a+C),l=S-1}let n=p.join("+"),h=[];for(let s=S;s<=u;s++)"JS"==e[s]&&h.push(this.basicCode(t[s].substring(1)));if(this.templateInClass[m]=h,-1===l)r=a.lastIndexOf("<"),i=a.indexOf(" ",r),t[S-1]=`${a.substring(0,i+1)} class="${f} ${f}_${n} ${f}Cnt${m}" ${a.substring(i+1)}`,m++;else{let e=t[l].match(C)[0],s=t[l].replace(e,"");t[l]=`${e}${f} ${f}_${n} ${f}Cnt${m} ${s}`,m++}}else t[S-1]+=`<span class="${f} ${f}Cnt${m}">`,m++,t[u+1]="</span>"+t[u+1];else r=a.lastIndexOf("<"),i=a.lastIndexOf(">"),n=a.indexOf(" ",r),h=-1==n||n>i?a.substring(r+1,i):a.substring(r+1,a.length).split(" ")[0],"</"!=a.substring(r,r+2)&&t[u+1].includes("</"+h)&&t[u+1].indexOf("</"+h)<(-1==t[u+1].indexOf("<"+h)?t[u+1].length:t[u+1].indexOf("<"+h))?0==this.removeControlText(t[u+1]).trim().indexOf("</"+h)?(i=a.length,r=a.lastIndexOf("<"),c=a.substring(r,i),c.includes("class=")?(d=a.indexOf("class=",r)+7,t[S-1]=`${a.substring(0,d)}${f} ${f}Cnt${m} ${a.substring(d)}`,m++):(i=a.lastIndexOf(">"),t[S-1]=`${a.substring(0,i)} class="${f} ${f}Cnt${m}" ${a.substring(i,a.length)}`,m++)):(r=0,i=t[u+1].indexOf("</"),t[S-1]=`${t[S-1]}<span class="${f} ${f}Cnt${m}">`,m++,t[u+1]=`</span>${t[u+1]}`):(t[S-1]=`${t[S-1]}<span class="${f} ${f}Cnt${m}">`,m++,t[u+1]=`</span>${t[u+1]}`)}else l=s[S];return{type:e,code:t,syncCnt:m}}getTitle(e){const t=/<head>[\s\S]*?<\/head>/g,s=/<title>[\s\S]*?<\/title>/g,l=null==e.match(t)?"":e.match(t)[0],r=null==l.match(s)?"":l.match(s)[0].replace("<title>","").replace("</title>","").trim();this.titleCode=r.length>0?r:this.titleCode}changeTitle(e){const t=`${this.openDelimiter}[^%][\\s\\S]*?${this.closeDelimiter}`,s=new RegExp(t,"g");let l=null,r="",i=0;null!=e.trim().match(s)?(l=e.trim().match(s)[0].replaceAll(`${this.openDelimiter}`,"").replaceAll(`${this.closeDelimiter}`,""),i=1):r=e,i&&(r=this.basicCode(l)),document.querySelector("title")&&(document.querySelector("title").innerHTML=r)}removeComment(e){return e.replace(/<!--[\s\S]*?-->/gm,"")}async changeCss(e){e=this.removeComment(e);let t=await this.combineCss(e),{types:s,codes:l}=this.seperateCode(t,"second");this.cssCode=l,this.cssType=s,t=this.interpret(s,l).join("");let r=this.parseCSS(t);this.cssRules=r;const i=this.createTextStyle(r);if(""==i)return;document.querySelectorAll("style").forEach((e=>{e.parentNode.removeChild(e)}));let n=document.createElement("style");n.appendChild(document.createTextNode(i)),document.head.appendChild(n),document.head.querySelectorAll("link").forEach((e=>{"stylesheet"!=e.getAttribute("rel")||e.getAttribute("href").includes("http")||e.parentNode.removeChild(e)}))}changeCssFromCombinedStyle(e){let{types:t,codes:s}=this.seperateCode(e,"second");this.cssCode=s,this.cssType=t,e=this.interpret(t,s).join("");let l=this.parseCSS(e);this.cssRules=l;const r=this.createTextStyle(l);if(""==r)return;document.querySelectorAll("style").forEach((e=>{e.parentNode.removeChild(e)}));let i=document.createElement("style");i.appendChild(document.createTextNode(r)),document.head.appendChild(i),document.head.querySelectorAll("link").forEach((e=>{"stylesheet"==e.getAttribute("rel")&&e.getAttribute("href").indexOf("http")<0&&e.parentNode.removeChild(e)}))}async combineCss(e){let t=[],s=[],l=e.indexOf("<head>"),r=e.indexOf("</head>");if(-1==l||-1==r)return"";e.replace(/<style>[\s\S]*?<\/style>/gi,(function(e){return s.push(e.replaceAll("<style>","").replaceAll("</style>","")),""}));let i=s.join(""),n=[];e.replace(/<link.*?rel="stylesheet"[\s\S]*?\/?>/gi,(function(e){return n.push(e),""}));let c=this.currentUrl().host;n.forEach((e=>{let s=e.match(/href=".*?"/gi)[0].replaceAll("href=","").replaceAll('"',"");s.indexOf("http")<0&&t.push(new URL(s,c).href)}));let h=await this.getTextFromFiles(t),a=[];t.forEach((e=>{a.push(this.getComparedPath(e,this.currentUrl().host))}));for(let e=0;e<h.length;e++)h[e]=this.replaceRelativeUrl(h[e],a[e]);return i=h.reduce(((e,t)=>e+t),i),i=await this.insertNestedCSS(i),i}getOnlyPath(e){let t=e.split("/");return t.pop(),t.join("/")}splitUrl(e){let t=e.split("/");return""==t[t.length-1]&&t.pop(),""==t[0]&&t.shift(),t}getRelativeUrl(e){let t=this.currentUrl().host,s=this.splitUrl(e),l=this.splitUrl(t),r=[];for(let e=0;e<l.length;e++)l[e]!==s[e]?r.push(".."):s[e]=".";s=[...r,...s];for(let e=0;e<s.length;e++)"."==s[e]&&"."==s[e+1]&&(s[e]="_erase_");for(let e=s.length-1;e>=0;e--)("_erase_"==s[e]||"."==s[e]&&e>0)&&s.splice(e,1);return"/"+s.join("/")+"/"}getComparedPath(e,t){e=this.getOnlyPath(e),e=this.getRelativeUrl(e),t=this.getRelativeUrl(t);let s=this.splitUrl(e),l=this.splitUrl(t),r=[];for(let e=0;e<l.length;e++)l[e]!==s[e]?""!==l[e]&&r.push(".."):s[e]=".";return s=[...r,...s],s.join("/")+"/"}replaceRelativeUrl(e,t){function s(e,t){if(!e.includes("/"))return t+e;if("/"==e.substring(0,1))return t+e.substring(1);if("./"==e.substring(0,2))return t+e.substring(2);if("../"==e.substring(0,3)){let s=t.split("/");return s.pop(),s.pop(),(t=s.join("/")+"/")+e.substring(3)}}return e.replace(/(@import *['"])(.*?)(['"])|(url\(['"]?)(.*?)(['"]?\))/g,(function(e,l,r,i,n,c,h){return null==l?n+(c=s(c,t))+h:l+(r=s(r,t))+i}))}htmlReplaceRelativeUrl(e,t){function s(e,t){if(!e.includes("/"))return t+e;if("/"==e.substring(0,1))return t+e.substring(1);if("./"==e.substring(0,2))return t+e.substring(2);if("../"==e.substring(0,3)){let s=t.split("/");return s.pop(),s.pop(),(t=s.join("/")+"/")+e.substring(3)}}return e.replace(/(\<[a-z]* *src *= *['"`])((?!http|\<\%).*)(['"`])|(href *= *['"`])((?!http|\<\%|#).*[^\>\%])(['"`])|(\<\%[^\%] *include *\(?["'`])(.*)(["'`])/g,(function(e,l,r,i,n,c,h,a,o,u){return void 0!==l?l+(r=s(r,t))+i:void 0!==n?n+(c=s(c,t))+h:a+(o=s(o,t))+u}))}async insertNestedCSS(e){let t="",{urls:s,orders:l,codes:r,media:i}=this.findImport(e);if(0==s.length)return t=r.join(""),t;let n=await this.getTextFromFiles(s),c=[];s.forEach((e=>{c.push(this.getComparedPath(e,this.currentUrl().host))}));for(let e=0;e<n.length;e++)n[e]=this.replaceRelativeUrl(n[e],c[e]);return n.forEach(((e,t)=>{r[l[t]]=""!==i[t]?this.insertMedia(e,i[t]):e})),t=r.join(""),({urls:s,orders:l,codes:r,media:i}=this.findImport(t)),0!=s.length?(t=await this.insertNestedCSS(t),t):t}insertMedia(e,t){return`@media ${t} { ${e} }`}findImport(e){let t=[],s=[],l=[],r=[],i="",n=0;const c=/(@import *?(?:url)?\(?["'].*["']\)? *?.*;)/g,h=/[^(?:\.)|(?:\.\/)].*/g;let a=e.split(c);t=[...e.matchAll(/@import *?(url)?\(?["'](.*)["']\)? *?(.*);/g)];for(let e=0;e<a.length;e++)-1==a[e].search(c)||a[e].includes("http")?a[e]=this.removeControlText(a[e]).trim():(r[n]=e,n++);return t.forEach((e=>{i=e[2].match(h)[0].trim(),s.push(this.currentUrl().host+i),l.push(null===e[3]?"":e[3].trim())})),{urls:s,orders:r,codes:a,media:l}}createTextStyle(e){let t="",s=e.length;for(let l=0;l<s;l++){let s=e[l];switch(null==s.type?"":s.type){case"":case"font-face":t=t+s.selector+" {\n",s.rules.forEach((e=>{t+=`    ${e.key}: ${e.value};\n`})),t+="}\n";break;case"imports":case"keyframes":t+=s.styles.replaceAll("{","{\n").replaceAll("}","}\n").replaceAll(";",";\n")+"\n";break;case"supports":case"media":t+=s.selector+" {\n",s.subStyles.forEach((e=>{t+="    "+e.selector+" {\n",e.rules.forEach((e=>{t+=`        ${e.key}: ${e.value};\n`})),t+="    }\n"})),t+="}\n"}}return t}async renderPart(e="",t=""){let s="",l="",r=[],i=[],n="",c="",h=[],a=[],o="";if(""==t.trim())return"select type from html, html_path";if(""==e.trim())return"nothing to render";switch(t){case"HTML":s=e;let{fileIncludedHTML:t,codeList:u}=await this.insertNestedHTML(s),d=this.insertModules(t);return r=this.seperateCode(d,"second"),i=this.makeSyncBlock(r.types,r.codes),"JS"==r.types[0]&&(r.types.unshift("HTML"),r.codes.unshift(" "),i=i.map((e=>e+1)),i.unshift(0)),r=this.insertSync(r.types,r.codes,i),this.syncCnt=r.syncCnt,l=this.interpret(r.type,r.code),n=l.join(""),{domText:n,sourceType:r.type,sourceCode:r.code,sourceSync:i};case"CSS":return s=e,s=await this.insertNestedCSS(s),r=this.seperateCode(s,"second"),h=this.interpret(r.type,r.code),c=h.join(""),a=this.parseCSS(c),o=this.createTextStyle(a),{cssText:o,cssRules:a,cssType:r.type,cssCode:r.code}}}async appendHTML(e="",t){if(""==e)return"nothing to append";let s=await this.renderPart(e,"HTML"),l=s.domText||"";if(null==t)return"no element to append to";const r=s.sourceType||[],i=s.sourceCode||[],n=s.sourceSync||[];return"DOMobject"!=this.getObjectType(t)?"invalid element to append into":0==r.length?"nothing to append":(this.htmlType=[...this.htmlType,...r],this.htmlCode=[...this.htmlCode,...i],this.htmlSync=[...this.htmlSync,...n],l=l.trim(),""==l?"nothing to append":(t.insertAdjacentHTML("beforeend",l),"success"))}async appendCSS(e=""){if(""==e)return;let t,s=await this.renderPart(e,"CSS"),l=s.cssText||"",r=s.cssRules||[],i=s.cssType||[],n=s.cssCode||[];return null==document.querySelector("style")?(t=document.createElement("style"),t.appendChild(document.createTextNode(l)),document.head.appendChild(t),this.cssRules=[...this.cssRules,...r],this.cssType=[...this.cssType,...i],this.cssCode=[...this.cssCode,...n],"success"):(t=document.createTextNode(l),document.querySelector("style").appendChild(t),this.cssRules=[...this.cssRules,...r],this.cssType=[...this.cssType,...i],this.cssCode=[...this.cssCode,...n],"success")}basicCode(e){try{return Function(`"use strict"; return ( ${e.substring(1)} )`)()}catch(e){return"invalid template"}}controlCode(e){try{return Function(`"use strict"; ${e.replace(/[\n\r\t]/g,"")}`)()}catch(e){return"invalid template block"}}currentUrl(){let e=window.location.href,t=window.location.hash;e=e.replace(t,"");let s=e.split("/").pop(),l=e.substring(0,e.length-s.length);return""!=t&&(s=t.substring(1)+".html"),{host:l,filename:s}}async getTextFromFiles(e){if(0==e.length)return[];let t=e.map((e=>fetch(e))),s=await Promise.allSettled(t),l=[];s.map(((e,t)=>{e.value.ok||l.push(t)})),s=s.filter((e=>e.value.ok));let r=s.map((e=>e.value));s=await Promise.all(r);let i=s.map((e=>e.text())),n=await Promise.all(i);return l.map((e=>n.splice(e,0,"error: check your path of include"))),n}removeAllChildNodes(e){for(;e.firstChild;)e.removeChild(e.firstChild)}parseCSS(e){if(void 0===e)return[];let t=/@import .*?\(.*?\);/g,s=/((@keyframes[\s\S]*?){([\s\S]*?}\s*?)})/g,l=[],r=[...(e=e.replace(/\/\*.*?\*\//g,"")).matchAll(t)],i=r.length;for(let e=0;e<i;e++){let t=r[e];l.push({selector:"@imports",type:"imports",styles:t[0]})}let n=[...(e=e.replace(t,"")).matchAll(s)],c=n.length;for(let e=0;e<c;e++){let t=n[e];l.push({selector:"@keyframes",type:"keyframes",styles:t[0]})}let h=[...(e=e.replace(s,"")).matchAll(/((\s*?(?:\/\*[\s\S]*?\*\/)?\s*?(@media|@supports)[\s\S]*?){([\s\S]*?)}\s*?})|(([\s\S]*?){([\s\S]*?)})/g)],a=h.length;for(let e=0;e<a;e++){let t=h[e],s=void 0===t[2]?t[6]:t[2];s=this.standardReturn(s);let r=s.includes("@media")?"media":s.includes("@supports")?"supports":"@font-face"===s?"font-face":"",i={selector:s,type:r};"media"===r||"supports"===r?i.subStyles=this.parseCSS(t[4]+"\n}"):i.rules=this.parseRules(t[7]),l.push(i)}return l}parseRules(e){let t=[],s=(e=this.standardReturn(e).split(";")).length;for(let l=0;l<s;l++){let s=e[l];if(s=s.trim(),s.includes(":")||"base64,"!==s.trim().substring(0,7)){if(s.includes(":")){s=s.split(":");let e=s[0].trim(),l=s.slice(1).join(":").trim();e.length>0&&l.length>0&&t.push({key:e,value:l})}}else t[t.length-1].value+=s.trim()}return t}standardReturn(e){return e.split("\r\n").join("\n").replace(/\n+/,"\n").trim()}arrayFind(e,t){let s={},l=e.length;for(let t=0;t<l;t++)s[e[t]]=t;return s.hasOwnProperty(t)?s[t]:-1}escapeHtml(e){let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;","(":"&#40;",")":"&#41;"};return e.replace(/[&<>"'()]/g,(function(e){return t[e]}))}removeControlText(e){return e.replaceAll(/\r|\n|\t/g,"")}verifyFilename(e){return 0==e.trim().length?"":new URL(e,this.currentUrl().host).href.replaceAll(this.currentUrl().host,"")}getObjectType(e){return("object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&null!==e&&1===e.nodeType&&"string"==typeof e.nodeName)?"DOMobject":e.includes(this.openDelimiter)&&e.includes(this.closeDelimiter)?"template":e.includes(".html")?"html_path":e.includes(".css")?"css_path":"undefined"}}document.onmouseover=function(){window.innerDocClick=!0},document.onmouseleave=function(){window.innerDocClick=!1};