"use strict";class eTemplate{constructor({openDelimiter:e="<%",closeDelimiter:t="%>",syncClass:s="et_sync",startUrl:l="",urlList:r=[]}={}){this.htmlCode=[],this.htmlType=[],this.htmlSync=[],this.cssRules=[],this.cssCode=[],this.cssType=[],this.syncCnt=0,this.templateInClass=[],this.titleCode="",this.metaArray=[],this.startUrl=l,this.syncClass=s,this.openDelimiter=e,this.closeDelimiter=t,this.commentDelimiter=e+"%",this.preRead=[],this.urlList=r,this.fileName="",this.scripts=[],this.currentHash=""}async render({url:e="",scroll:t={},scope:s=""}={},l=function(){}){this.syncCnt=0,"function"==typeof arguments[0]&&(l=arguments[0]),e=""===e?""!==this.startUrl?this.startUrl:this.currentUrl().filename:e,e=this.verifyFilename(e),this.urlList=this.urlList.map((e=>this.verifyFilename(e)));let r=this.urlList.indexOf(e)||0,i="";if(this.fileName=e,0==this.preRead.length){this.urlList.length>0&&this.preReadFiles(this.urlList,s);let t=this.currentUrl().host+e;const l=await fetch(t),r=await l.text();this.readMeta(r),this.changeMeta(),this.getTitle(r),this.changeTitle(this.titleCode);const n=await this.readFurther(r,s);i=n.htmlBlock.join("")+this.scripts.join(""),this.htmlCode=n.codeList.code,this.htmlType=n.codeList.type}else{let e=this.preRead[r].fileIncludedHTML,t=this.preRead[r].cssText;this.titleCode=this.preRead[r].titleCode,this.metaArray=this.preRead[r].metaArray,this.templateInClass=[],this.syncCnt=0,this.changeMeta(),this.changeTitle(this.titleCode),"body"!==s&&this.changeCssFromCombinedStyle(t);let l=this.insertModules(e);const n=await this.readFurtherFromCombinedHTML(l);i=n.htmlBlock.join(""),this.htmlCode=n.codeList.code,this.htmlType=n.codeList.type}if(this.removeAllChildNodes(document.querySelector("body")),document.body.insertAdjacentHTML("afterbegin",i),t!={}&&0!=Object.keys(t).length){let e=document.getElementById(t.id),s=["start","center","end"].some((e=>e==t.position));t.position=s?t.position:"center",null!==e&&e.scrollIntoView({block:t.position})}return document.body.style.display="block",l(),new Promise(((e,t)=>{e("done")}))}async preReadFiles(e,t){let s=[];for(let l=0;l<e.length;l++){const r=new URL(e[l],this.currentUrl().host).href;s[l]=new Worker(this.currentUrl().host+"js/worker.min.js"),s[l].postMessage({path:r,scope:t}),s[l].onmessage=e=>{this.preRead[l]=e.data,s[l].terminate()}}}storeScript(e){let t=[];this.scripts=t;let s=e.match(/<body*?>(\n|\r|\t|.)*/gm);return null===s?e:(t=s[0].match(/<script[\s\S]*?>[\s\S]*?<\/script>/gm,""),null===t||(t.forEach((t=>e=e.replace(t,""))),this.scripts=t),e)}async readFurther(e,t){e=this.removeComment(e),e=this.storeScript(e),"body"!==t&&await this.changeCss(e);let{fileIncludedHTML:s,codeList:l}=await this.insertNestedHTML(e),r=this.insertModules(s),{types:i,codes:n}=this.seperateCode(r,"second"),c=this.makeSyncBlock(i,n);"JS"==i[0]&&(i.unshift("HTML"),n.unshift(" "),c=c.map((e=>e+1)),c.unshift(0)),l=this.insertSync(i,n,c),this.htmlSync=c,this.syncCnt=l.syncCnt;let o=this.interpret(i,n);return new Promise(((e,t)=>{e({htmlBlock:o,codeList:l})}))}async readFurtherFromCombinedHTML(e){let t=this.insertModules(e),{types:s,codes:l}=this.seperateCode(t,"second"),r=this.makeSyncBlock(s,l);"JS"==s[0]&&(s.unshift("HTML"),l.unshift(" "),r=r.map((e=>e+1)),r.unshift(0));let i=this.insertSync(s,l,r);return this.htmlSync=r,this.syncCnt=i.syncCnt,{htmlBlock:this.interpret(s,l),codeList:i}}sync(e){let t="",s=this.syncClass;new RegExp("${eClass}_");this.changeMeta(),this.changeTitle(this.titleCode);const l=document.querySelectorAll(`input.${s}`);for(let e=0;e<l.length;e++){let s=l[e];if(t=s.getAttribute("data-sync"),null==t)continue;let r="number"==s.type?"":'"';t+="="+(s.value?`${r}${this.escapeHtml(s.value)}${r};`:'"";');try{this.controlCode(t)}catch(e){return e}}let r=this.interpretPart(this.htmlType,this.htmlCode);const i=document.querySelectorAll(`.${s}`);for(let e=0;e<i.length;e++){let l=i[e],n=[...l.classList],c=void 0!==n.find((e=>e.startsWith(s+"_"))),o=n.find((e=>e.startsWith(s+"Cnt"))),h=void 0!==o?parseInt(o.replace(`${s}Cnt`,""),10):0;if(c){for(let e=0;e<r[h].length;e++)if(this.templateInClass[h][e][1]!=r[h][e])if("class"==this.templateInClass[h][e][0])l.classList.remove(this.templateInClass[h][e][1]),l.classList.add(r[h][e]),this.templateInClass[h][e][1]=r[h][e];else if(this.templateInClass[h][e][0].includes("data-")){let s=this.templateInClass[h][e][0].substring(this.templateInClass[h][e][0].indexOf("data-")+5);t=l.dataset[s],t=t.replace(this.templateInClass[h][e][1],r[h][e]),l.dataset[s]=t,this.templateInClass[h][e][1]=r[h][e]}else t=l.getAttribute(this.templateInClass[h][e][0]),t=t.replace(this.templateInClass[h][e][1],r[h][e]),l.setAttribute(this.templateInClass[h][e][0],t),this.templateInClass[h][e][1]=r[h][e]}else{if(l.innerHTML==r[h])continue;this.removeAllChildNodes(l),l.insertAdjacentHTML("afterbegin",r[h])}}"body"!=e&&this.syncCss()}syncCss(){if(0==this.cssType.length||!this.cssType.includes("JS"))return;let e=this.interpret(this.cssType,this.cssCode),t=this.parseCSS(e.join("")),s=0;for(let e=0;e<document.styleSheets.length;e++)if(null==document.styleSheets[e].href){s=e;break}const l=/\s+|\\n/g;let r=this.cssRules,i=r.length,n="",c=[],o=[],h=t.length;for(let e=0;e<h;e++){let h=t[e],a=null==h.type?"":h.type,u=-1,d=0,p="";switch(a){case"keyframes":for(let e=0;e<i;e++){let t=r[e],s=h.styles.substring(0,h.styles.indexOf("{")).trim(),l=t.styles.substring(0,t.styles.indexOf("{")).trim();if("keyframes"==t.type&&s==l){u=e;break}}if(-1==u){c.push(["rule",e,-1,-1,h.styles]);break}let t=r[u].styles,m=h.styles;t.replace(l,"")!=m.replace(l,"")&&(document.styleSheets[s].deleteRule(u),document.styleSheets[s].insertRule(m,u)),o.push([u,-2,0,7]);break;case"media":case"supports":d="media"==a?4:12;for(let e=0;e<i;e++){let t=r[e];if(t.type==a&&h.selector==t.selector){u=e;break}}if(-1==u){n=h.selector+" {\n";let t=h.subStyles.length;for(let e=0;e<t;e++){let t=h.subStyles[e];n+="    "+t.selector+" {\n";let s=t.rules.length;for(let e=0;e<s;e++)n+=`        ${t.rules[e].key}: ${t.rules[e].value};\n`;n+="    }\n"}n+="}\n",c.push(["rule",e,-1,-1,n]);break}for(let t=0;t<h.subStyles.length;t++){let l=h.subStyles[t];p=l.selector;let i=-1,a=r[u].subStyles.length;for(let e=0;e<a;e++)if(r[u].subStyles[e].selector==p){i=e;break}if(-1!=i)for(let n=0;n<l.rules.length;n++){let h=l.rules[n],a=-1,p=r[u].subStyles[i].rules.length;for(let e=0;e<p;e++){if(r[u].subStyles[i].rules[e].key==h.key){a=e;break}}if(-1==a){c.push(["style",e,t,n,h.key,h.value]);continue}let m=r[u].subStyles[i].rules[a].key,f=r[u].subStyles[i].rules[a].value,y=h.value;f!=y&&document.styleSheets[s].cssRules[u].cssRules[i].style.setProperty(m,y),o.push([u,i,a,d])}else{n="    "+l.selector+" {\n";for(let e=0;e<l.rules.length;e++)n+=`        ${l.rules[e].key}: ${l.rules[e].value};\n`;n+="    }\n",c.push(["rule",e,t,-1,n])}}break;case"":case"font-face":d="font-face"==a?5:1;for(let t=e;t<i;t++){let e=r[t];if(h.selector==e.selector){u=t;break}}if(-1==u){n=h.selector+" {\n";let t=h.rules.length;for(let e=0;e<t;e++)n+=`    ${h.rules[e].key}: ${h.rules[e].value};\n`;n+="}\n",c.push(["rule",e,-1,-1,n]);break}let f=h.rules.length;for(let t=0;t<f;t++){let l=h.rules[t],i=-1,a=r[u].rules.length;for(let e=0;e<a;e++){if(r[u].rules[e].key==l.key){i=e;break}}if(-1==i){n=`    ${l.key}: ${l.value};\n`,c.push(["style",e,-1,t,l.key,l.value]);continue}let p=r[u].rules[i].key,m=r[u].rules[i].value,f=l.value;m!=f&&document.styleSheets[s].cssRules[u].style.setProperty(p,f),o.push([u,-1,i,d])}}}let a=0,u=0;for(let e=r.length-1;e>=0;e--){let t=0,l=r[e];switch(l.type){case"media":case"supports":t="media"==l.type?4:12,a=l.subStyles.length;for(let r=a-1;r>=0;r--){u=l.subStyles[r].rules.length;for(let i=u-1;i>=0;i--){if(this.arrayFind(o,[e,r,i,t])<0){let t=l.subStyles[r].rules[i].key;document.styleSheets[s].cssRules[e].cssRules[r].style.removeProperty(t)}}0==document.styleSheets[s].cssRules[e].cssRules[r].style.length&&document.styleSheets[s].cssRules[e].deleteRule(r)}0==document.styleSheets[s].cssRules[e].cssRules.length&&document.styleSheets[s].deleteRule(e);break;case"":case"font-face":t=""==l.type?1:5,u=l.rules.length;for(let r=u-1;r>=0;r--){if(this.arrayFind(o,[e,-1,r,t])<0){let t=l.rules[r].key;document.styleSheets[s].cssRules[e].style.removeProperty(t)}}0==document.styleSheets[s].cssRules[e].style.length&&document.styleSheets[s].deleteRule(e);break;case 7:this.arrayFind(o,[e,-2,0,7])<0&&document.styleSheets[s].deleteRule(e)}}let d=c.length;for(let e=0;e<d;e++){let[t,l,r,i,n,o=""]=c[e];if("style"==t)-1==r?document.styleSheets[s].cssRules[l].style.setProperty(n,o):document.styleSheets[s].cssRules[l].cssRules[r].style.setProperty(n,o);else{if(-1!=r){document.styleSheets[s].cssRules[l].insertRule(n,r);continue}document.styleSheets[s].insertRule(n,l)}}this.cssRules=JSON.parse(JSON.stringify(t))}findInclude(e){const t=/< *?body *?>[\s\S]*?< *?\/ *?body>/g,s=/ *?include\( *?["'`](.*?)["'`] *?\)/g,l=/ *?include\( *?["'`]/g,r=/["'`] *?\).*/g;let i=[],n=[],c="",o="";o=null===e.match(t)?e:e.match(t)[0].replace(/< *?body *?>/g,"").replace(/< *?\/ *?body *?>/g,"");let{codes:h,types:a}=this.seperateCode(o,"first"),u=a.length,d=this.currentUrl().host;for(let e=0;e<u;e++)"JS"==a[e]&&s.test(h[e])&&(c=h[e].match(s)[0].replace(l,"").replace(r,""),i.push(new URL(c,d).href),n.push(e));return{urls:i,orders:n,codeList:h}}async insertNestedHTML(e,t=[]){let s="",{urls:l,orders:r,codeList:i}=this.findInclude(e,t);if(0==l.length)return s=this.removeComment(i.join("")),{fileIncludedHTML:s,codeList:i};let n=[];l.forEach(((e,t)=>{n.push(this.getComparedPath(e,this.currentUrl().host))}));let c=await this.getTextFromFiles(l);for(let e=0;e<c.length;e++)c[e]=this.htmlReplaceRelativeUrl(c[e],n[e]);return c.forEach(((e,t)=>{i[r[t]]=e})),s=this.removeComment(i.join("")),await this.insertNestedHTML(s,n)}insertModules(e){const t=/<%#.*?%>/g,s=/<%# */g,l=/ *%>/g;let{types:r,codes:i}=this.seperateCode(e,"first"),n=0,c=r.length;for(let e=0;e<c;e++)if("JS"==r[e]&&i[e].includes("<%#")){let r=" "+i[e].match(t)[0].replace(s,"").replace(l,"");try{i[e]=this.basicCode(r),n++}catch{i[e]='<%= "invalid module" %>',n++}}let o=i.join("");return 0!==n&&(o=this.insertModules(o)),o}seperateCode(e,t){const s=`(${this.openDelimiter}[^%][\\s\\S]*?${this.closeDelimiter})`,l=new RegExp(s,"g");let r=e.split(l),i=[],n=r.length;for(let e=0;e<n;e++){let s=r[e],n=l.test(s)?"JS":"HTML";r[e]="JS"===n&&"second"===t?s.substring(2,s.length-2).trim():s,i.push(n)}let c=i.length;if(c>1)for(let e=c-1;e>=1;e--)i[e]==i[e-1]&&"HTML"==i[e]&&(r[e-1]=r[e-1]+r[e],r.splice(e,1),i.splice(e,1));return{types:i,codes:r}}interpret(e,t){let s=[],l=0,r=this.escapeHtml(this.commentDelimiter.replace(this.commentDelimiter,this.openDelimiter)),i=this.escapeHtml(this.closeDelimiter),n=t.length;for(;l<n;){switch(e[l]){case"HTML":s.push(t[l].replaceAll(this.commentDelimiter,r).replaceAll(this.closeDelimiter,i));break;case"JS":if(0==t[l].search(/=|-/g)){try{s.push(this.basicCode(t[l]))}catch(e){s.push("invalid template")}break}{let r=this.eachBlock(e,t,l);l=r.index;try{s.push(this.controlCode(r.partBlock))}catch(e){s.push("invalid template")}break}}l++}return s}interpretPart(e,t){let s=[],l=-1,r=-1;for(let i=0;i<t.length;i++){let n=t[i],c=e[i],o=this.htmlSync[i];if(o!=r&&"JS"==c&&(l++,r=o),"HTML"==c)continue;if(0==n.search(/=|-/g)){if(null==this.templateInClass[l]){try{s.push(this.basicCode(n))}catch(e){s.push("invalid template script")}continue}try{this.htmlSync[i]!=this.htmlSync[i-1]?s.push([this.basicCode(n)]):s[s.length-1].push(this.basicCode(n))}catch(e){s.push("invalid template script")}continue}let h=this.eachBlock(e,t,i);i=h.index;try{s.push(this.controlCode(h.partBlock))}catch(e){s.push("invalid template script")}}return s}makeSyncBlock(e,t){let s=[],l=0,r=0,i=0,n=t.length;for(let c=0;c<n;c++){switch(e[c]){case"HTML":s.push(l);break;case"JS":if(0==t[c].search(/=|-/g)){s.push(l);break}{let n=this.findBlockEnd(e,t,c);r=n.index,i=n.braceBalance,i<0?console.log("ERROR: missing {"):i>0&&console.log("ERROR: missing }"),s=[...s,...Array(r-c+1).fill(l)],c=r;break}}l++}return s}findBlockEnd(e,t,s){let l=0,r=0,i=t.length;for(r=s;r<i;r++)if(r!=s||"JS"!=e[r]){if("HTML"!=e[r]&&"JS"==e[r]&&0!==t[r].search(/=|-/g)&&(t[r].includes("{")&&l++,t[r].includes("}")&&l--,0==l))return{index:r,error:0}}else if(t[r].includes("{")&&l++,t[r].includes("}")&&l--,0==l)return{index:r,error:0};return 0!=l?{index:s,braceBalance:l}:{index:r,braceBalance:l}}eachBlock(e,t,s){let l="",r=0,i=t.length,n=0;for(n=s;n<i;n++){if(n==s){if("JS"==e[n]){if(t[n].includes("{")&&r++,t[n].includes("}")&&r--,0==r)return{partBlock:t[n],index:n};l=`let eTemplateInterpreted=${String.fromCharCode(96)}${String.fromCharCode(96)}; ${t[n]}`;continue}l=`let eTemplateInterpreted=${String.fromCharCode(96)}${t[n]}${String.fromCharCode(96)};`}switch(e[n]){case"HTML":""!==this.removeControlText(t[n]).trim()&&(l+=`eTemplateInterpreted += ${String.fromCharCode(96)}${t[n]}${String.fromCharCode(96)};`);continue;case"JS":if(0==t[n].search(/=|-/g))l+=`eTemplateInterpreted += ${t[n].substring(1)};`;else if(l+=t[n],t[n].includes("{")&&r++,t[n].includes("}")&&r--,0==r)return l+="; return eTemplateInterpreted;",{partBlock:l,index:n}}}return l+="; return eTemplateInterpreted;",{partBlock:l,index:n}}insertSync(e,t,s){let l=-1,r=0,i=0,n=0,c="",o="",h="",a=0,u=0,d=0,p=[],m=this.syncCnt,f=s.length;const y=this.syncClass,g=/[\s]+((-|\w)+) *= *["']/g,C=/[\s\S]+class[\s]*= *["']/g;for(let S=0;S<f;S++){if("JS"==e[S]&&(t[S]=t[S].trim()),s[S]==l||"JS"!=e[S]){l=s[S];continue}l=s[S],d=0,a=S,u=s.lastIndexOf(s[a]),h=t[S-1],p=[];let b=this.removeControlText(h),T=b.length-b.trimEnd().length;if(">"==b.substring(b.length-T-1).trim())if(r=h.lastIndexOf("<"),i=h.lastIndexOf(">"),n=h.indexOf(" ",r),o=-1==n||n>i?h.substring(r+1,i):h.substring(r+1,h.length).split(" ")[0],"</"!=h.substring(r,r+2))if(t[u+1].includes("</"+o)&&t[u+1].indexOf("</"+o)<(-1==t[u+1].indexOf("<"+o)?t[u+1].length:t[u+1].indexOf("<"+o))){if(0==this.removeControlText(t[u+1]).trim().indexOf("</"+o)){if(i=h.length,r=h.lastIndexOf("<"),c=h.substring(r,i),c.includes("class=")){d=h.indexOf("class=",r)+7,t[S-1]=`${h.substring(0,d)}${y} ${y}Cnt${m} ${h.substring(d)}`,m++;continue}i=h.lastIndexOf(">"),t[S-1]=`${h.substring(0,i)} class="${y} ${y}Cnt${m}" ${h.substring(i,h.length)}`,m++;continue}r=0,i=t[u+1].indexOf("</"),t[S-1]=`${t[S-1]}<span class="${y} ${y}Cnt${m}">`,m++,t[u+1]=`</span>${t[u+1]}`}else t[S-1]=`${t[S-1]}<span class="${y} ${y}Cnt${m}">`,m++,t[u+1]=`</span>${t[u+1]}`;else t[S-1]=`${t[S-1]}<span class="${y} ${y}Cnt${m}">`,m++,t[u+1]=`</span>${t[u+1]}`;else{if(i=h.lastIndexOf(">"),r=h.lastIndexOf("<"),i<r){h.substring(r+1,h.indexOf(" ",r));for(let l=S+1;l<f;l++)if("HTML"===e[l]&&t[l].indexOf(">")>0){for(let e=S+1;e<l;e++)s[e]=s[S];u=s.lastIndexOf(s[S]);break}let l=-1,n="";for(let s=S;s<=u;s++)if("JS"===e[s]){for(let e=s-1;e>=0;e--){let s=[...t[e].matchAll(g)];if(s.length>0){n=s[s.length-1][1],"class"==n&&(l=e);break}}""!=n&&p.push(n)}let c=[...new Set(p)].join("+"),o=[];for(let s=S;s<=u;s++)"JS"==e[s]&&o.push(this.basicCode(t[s].substring(1)));if(p.length>0&&(this.templateInClass[m]=[],p.map(((e,t)=>{this.templateInClass[m].push([e,o[t]])}))),-1===l)r=h.lastIndexOf("<"),i=h.indexOf(" ",r),t[S-1]=`${h.substring(0,i+1)} class="${y} ${y}_${c} ${y}Cnt${m}" ${h.substring(i+1)}`,m++;else{let e=t[l].match(C)[0],s=t[l].replace(e,"");t[l]=`${e}${y} ${y}_${c} ${y}Cnt${m} ${s}`,m++}continue}t[S-1]+=`<span class="${y} ${y}Cnt${m}">`,m++,t[u+1]="</span>"+t[u+1]}}return{type:e,code:t,syncCnt:m}}getTitle(e){const t=/<head>[\s\S]*?<\/head>/g,s=/<title>[\s\S]*?<\/title>/g,l=null==e.match(t)?"":e.match(t)[0],r=null==l.match(s)?"":l.match(s)[0].replace("<title>","").replace("</title>","").trim();this.titleCode=r.length>0?r:this.titleCode}changeTitle(e){const t=`${this.openDelimiter}[^%][\\s\\S]*?${this.closeDelimiter}`,s=new RegExp(t,"g");let l=null,r="",i=!1;null!=e.trim().match(s)?(l=e.trim().match(s)[0].replaceAll(`${this.openDelimiter}`,"").replaceAll(`${this.closeDelimiter}`,""),i=!0):r=e,i&&(r=this.basicCode(l)),document.querySelector("title")&&(document.querySelector("title").innerHTML=r)}readMeta(e){const t=document.createElement("document");t.insertAdjacentHTML("beforeend",e);const s=t.querySelectorAll("meta");let l=[];s.forEach(((e,t)=>{for(let s=0;s<e.attributes.length;s++)e.attributes[s].value.indexOf(this.openDelimiter)>-1&&l.push({metaNo:t,attributeNo:s,nodeName:e.attributes[s].name,nodeValue:e.attributes[s].value})})),this.metaArray=JSON.parse(JSON.stringify(l))}changeMeta(){if(0==this.metaArray.length)return;const e=`(${this.openDelimiter}[^%][\\s\\S]*?${this.closeDelimiter})`,t=new RegExp(e,"g");let s=document.querySelectorAll("meta");this.metaArray.forEach((e=>{let l=e.nodeValue.split(t),r=!1;for(let e=0;e<l.length;e++){if(-1==l[e].indexOf(this.openDelimiter))continue;let t=l[e].replace(this.openDelimiter,"").replace(this.closeDelimiter,"").trim(),s=this.basicCode(t.substring(1));l[e]=s,r=!0}r&&(s[e.metaNo].attributes[e.attributeNo].nodeValue=l.join(""))}))}removeComment(e){return e.replace(/<!--[\s\S]*?-->/gm,"")}async changeCss(e){e=this.removeComment(e);let t=await this.combineCss(e),{types:s,codes:l}=this.seperateCode(t,"second");this.cssCode=l,this.cssType=s,t=this.interpret(s,l).join("");let r=this.parseCSS(t);this.cssRules=r;const i=this.createTextStyle(r);if(""==i)return;document.querySelectorAll("style").forEach((e=>{e.parentNode.removeChild(e)}));let n=document.createElement("style");n.appendChild(document.createTextNode(i)),document.head.appendChild(n),document.head.querySelectorAll("link").forEach((e=>{"stylesheet"!=e.getAttribute("rel")||e.getAttribute("href").includes("http")||e.parentNode.removeChild(e)}))}changeCssFromCombinedStyle(e){let{types:t,codes:s}=this.seperateCode(e,"second");this.cssCode=s,this.cssType=t,e=this.interpret(t,s).join("");let l=this.parseCSS(e);this.cssRules=l;const r=this.createTextStyle(l);if(""==r)return;document.querySelectorAll("style").forEach((e=>{e.parentNode.removeChild(e)}));let i=document.createElement("style");i.appendChild(document.createTextNode(r)),document.head.appendChild(i),document.head.querySelectorAll("link").forEach((e=>{"stylesheet"==e.getAttribute("rel")&&e.getAttribute("href").indexOf("http")<0&&e.parentNode.removeChild(e)}))}async combineCss(e){let t=[],s=[],l=e.indexOf("<head>"),r=e.indexOf("</head>");if(-1==l||-1==r)return"";e.replace(/<style>[\s\S]*?<\/style>/gi,(function(e){return s.push(e.replaceAll("<style>","").replaceAll("</style>","")),""}));let i=s.join(""),n=[];e.replace(/<link.*?rel="stylesheet"[\s\S]*?\/?>/gi,(function(e){return n.push(e),""}));let c=this.currentUrl().host;n.forEach((e=>{let s=e.match(/href=".*?"/gi)[0].replaceAll("href=","").replaceAll('"',"");s.indexOf("http")<0&&t.push(new URL(s,c).href)})),t=t.map((e=>this.removeControlText(e)));let o=await this.getTextFromFiles(t),h=[];t.forEach((e=>{h.push(this.getComparedPath(e,this.currentUrl().host))}));for(let e=0;e<o.length;e++)o[e]=this.replaceRelativeUrl(o[e],h[e]);return i=o.reduce(((e,t)=>e+t),i),i=await this.insertNestedCSS(i),i}getOnlyPath(e){let t=e.split("/");return t.pop(),t.join("/")}splitUrl(e){let t=e.split("/");return""==t[t.length-1]&&t.pop(),""==t[0]&&t.shift(),t}getRelativeUrl(e){let t=this.currentUrl().host,s=this.splitUrl(e),l=this.splitUrl(t),r=[];for(let e=0;e<l.length;e++)l[e]!==s[e]?r.push(".."):s[e]=".";s=[...r,...s];for(let e=0;e<s.length;e++)"."==s[e]&&"."==s[e+1]&&(s[e]="_erase_");for(let e=s.length-1;e>=0;e--)("_erase_"==s[e]||"."==s[e]&&e>0)&&s.splice(e,1);return"/"+s.join("/")+"/"}getComparedPath(e,t){e=this.getOnlyPath(e),e=this.getRelativeUrl(e),t=this.getRelativeUrl(t);let s=this.splitUrl(e),l=this.splitUrl(t),r=[];for(let e=0;e<l.length;e++)l[e]!==s[e]?""!==l[e]&&r.push(".."):s[e]=".";return s=[...r,...s],s.join("/")+"/"}replaceRelativeUrl(e,t){function s(e,t){if(!e.includes("/"))return t+e;if("/"==e.substring(0,1))return t+e.substring(1);if("./"==e.substring(0,2))return t+e.substring(2);if("../"==e.substring(0,3)){let s=t.split("/");return s.pop(),s.pop(),(t="."+s.join("/")+"/")+e.substring(3)}}return e.replace(/(@import *['"])(.*?)(['"])|(url\(['"]?)(.*?)(['"]?\))/g,(function(e,l,r,i,n,c,o){return null==l?c.indexOf("http")>-1?n+c+o:n+(c=s(c,t))+o:r.indexOf("http")>-1?l+r+i:l+(r=s(r,t))+i}))}htmlReplaceRelativeUrl(e,t){function s(e,t){if(!e.includes("/"))return t+e;if("/"==e.substring(0,1))return t+e.substring(1);if("./"==e.substring(0,2))return t+e.substring(2);if("../"==e.substring(0,3)){let s=t.split("/");return s.pop(),s.pop(),(t="."+s.join("/")+"/")+e.substring(3)}}return e.replace(/(\<[a-z]* *src *= *['"`])((?!http|\<\%).*)(['"`])|(href *= *['"`])((?!http|\<\%|#).*[^\>\%])(['"`])|(\<\%[^\%] *include *\(?["'`])(.*)(["'`])/g,(function(e,l,r,i,n,c,o,h,a,u){return void 0!==l?l+(r=s(r,t))+i:void 0!==n?n+(c=s(c,t))+o:h+(a=s(a,t))+u}))}async insertNestedCSS(e){let t="",{urls:s,orders:l,codes:r,media:i}=this.findImport(e);if(t=r.join(""),0==s.length)return t;let n=await this.getTextFromFiles(s),c=[];s.forEach((e=>{c.push(this.getComparedPath(e,this.currentUrl().host))}));for(let e=0;e<n.length;e++)n[e]=this.replaceRelativeUrl(n[e],c[e]);return n.forEach(((e,t)=>{r[l[t]]=""!==i[t]?this.insertMedia(e,i[t]):e})),t=r.join(""),await this.insertNestedCSS(t)}insertMedia(e,t){return`@media ${t} { ${e} }`}findImport(e){let t=[],s=[],l=[],r=[],i="",n=0;const c=/(@import *?(?:url)?\(?["'].*["']\)? *?.*;)/g,o=/[^(?:\.)|(?:\.\/)].*/g;let h=e.split(c);t=[...e.matchAll(/@import *?(url)?\(?["'](.*)["']\)? *?(.*);/g)];for(let e=0;e<h.length;e++)-1==h[e].search(c)||h[e].includes("http")?h[e]=this.removeControlText(h[e]).trim():(r[n]=e,n++);return t.forEach((e=>{i=e[2].match(o)[0].trim(),s.push(this.currentUrl().host+i),l.push(null===e[3]?"":e[3].trim())})),{urls:s,orders:r,codes:h,media:l}}createTextStyle(e){let t="",s=e.length;for(let l=0;l<s;l++){let s=e[l];switch(null==s.type?"":s.type){case"":case"font-face":t=t+s.selector+" {\n",s.rules.forEach((e=>{t+=`    ${e.key}: ${e.value};\n`})),t+="}\n";break;case"imports":case"keyframes":t+=s.styles.replaceAll("{","{\n").replaceAll("}","}\n").replaceAll(";",";\n")+"\n";break;case"supports":case"media":t+=s.selector+" {\n",s.subStyles.forEach((e=>{t+="    "+e.selector+" {\n",e.rules.forEach((e=>{t+=`        ${e.key}: ${e.value};\n`})),t+="    }\n"})),t+="}\n"}}return t}async renderPart(e="",t=""){let s="",l="",r=[],i=[],n="",c="",o=[],h=[],a="";if(""==t.trim())return"select type from html, html_path";if(""==e.trim())return"nothing to render";switch(t){case"HTML":s=e;let{fileIncludedHTML:t,codeList:u}=await this.insertNestedHTML(s),d=this.insertModules(t);return r=this.seperateCode(d,"second"),i=this.makeSyncBlock(r.types,r.codes),"JS"==r.types[0]&&(r.types.unshift("HTML"),r.codes.unshift(" "),i=i.map((e=>e+1)),i.unshift(0)),r=this.insertSync(r.types,r.codes,i),this.syncCnt=r.syncCnt,l=this.interpret(r.type,r.code),n=l.join(""),{domText:n,sourceType:r.type,sourceCode:r.code,sourceSync:i};case"CSS":return s=e,s=await this.insertNestedCSS(s),r=this.seperateCode(s,"second"),o=this.interpret(r.type,r.code),c=o.join(""),h=this.parseCSS(c),a=this.createTextStyle(h),{cssText:a,cssRules:h,cssType:r.type,cssCode:r.code}}}async appendHTML(e="",t){if(""==e)return"nothing to append";let s=await this.renderPart(e,"HTML"),l=s.domText||"";if(null==t)return"no element to append to";const r=s.sourceType||[],i=s.sourceCode||[],n=s.sourceSync||[];return"DOMobject"!=this.getObjectType(t)?"invalid element to append into":0==r.length?"nothing to append":(this.htmlType=[...this.htmlType,...r],this.htmlCode=[...this.htmlCode,...i],this.htmlSync=[...this.htmlSync,...n],l=l.trim(),""==l?"nothing to append":(t.insertAdjacentHTML("beforeend",l),"success"))}async appendCSS(e=""){if(""==e)return;let t,s=await this.renderPart(e,"CSS"),l=s.cssText||"",r=s.cssRules||[],i=s.cssType||[],n=s.cssCode||[];return null==document.querySelector("style")?(t=document.createElement("style"),t.appendChild(document.createTextNode(l)),document.head.appendChild(t),this.cssRules=[...this.cssRules,...r],this.cssType=[...this.cssType,...i],this.cssCode=[...this.cssCode,...n],"success"):(t=document.createTextNode(l),document.querySelector("style").appendChild(t),this.cssRules=[...this.cssRules,...r],this.cssType=[...this.cssType,...i],this.cssCode=[...this.cssCode,...n],"success")}basicCode(e){try{return Function(`"use strict"; return ( ${e.substring(1)} )`)()}catch(t){return console.log(e),console.error(t),"invalid template"}}controlCode(e){e=this.removeControlText(e);try{return Function(`"use strict"; ${e.replace(/[\n\r\t]/g,"")}`)()}catch(e){return console.error(e),"invalid template block"}}currentUrl(){let e=window.location.href,t=window.location.hash;e=e.replace(t,"");let s=e.split("/").pop(),l=e.substring(0,e.length-s.length);return""!=t&&(s=t.substring(1)+".html"),{host:l,filename:s}}async getTextFromFiles(e){if(0==e.length)return[];let t=e.map((e=>fetch(e))),s=await Promise.allSettled(t),l=[];s.map(((e,t)=>{e.value.ok||l.push(t)})),s=s.filter((e=>e.value.ok));let r=s.map((e=>e.value));s=await Promise.all(r);let i=s.map((e=>e.text())),n=await Promise.all(i);return l.map((e=>n.splice(e,0,"error: check your path of include"))),n}removeAllChildNodes(e){for(;e.firstChild;)e.removeChild(e.firstChild)}parseCSS(e){if(void 0===e)return[];let t=/@import .*?\(.*?\);/g,s=/((@keyframes[\s\S]*?){([\s\S]*?}\s*?)})/g,l=[],r=[...(e=e.replace(/\/\*.*?\*\//g,"")).matchAll(t)],i=r.length;for(let e=0;e<i;e++){let t=r[e];l.push({selector:"@imports",type:"imports",styles:t[0]})}let n=[...(e=e.replace(t,"")).matchAll(s)],c=n.length;for(let e=0;e<c;e++){let t=n[e];l.push({selector:"@keyframes",type:"keyframes",styles:t[0]})}let o=[...(e=e.replace(s,"")).matchAll(/((\s*?(?:\/\*[\s\S]*?\*\/)?\s*?(@media|@supports)[\s\S]*?){([\s\S]*?)}\s*?})|(([\s\S]*?){([\s\S]*?)})/g)],h=o.length;for(let e=0;e<h;e++){let t=o[e],s=void 0===t[2]?t[6]:t[2];s=this.standardReturn(s);let r=s.includes("@media")?"media":s.includes("@supports")?"supports":"@font-face"===s?"font-face":"",i={selector:s,type:r};"media"===r||"supports"===r?i.subStyles=this.parseCSS(t[4]+"\n}"):i.rules=this.parseRules(t[7]),l.push(i)}return l}parseRules(e){let t=[],s=(e=this.standardReturn(e).split(";")).length;for(let l=0;l<s;l++){let s=e[l];if(s=s.trim(),s.includes(":")||"base64,"!==s.trim().substring(0,7)){if(s.includes(":")){s=s.split(":");let e=s[0].trim(),l=s.slice(1).join(":").trim();e.length>0&&l.length>0&&t.push({key:e,value:l})}}else t[t.length-1].value+=s.trim()}return t}standardReturn(e){return e.split("\r\n").join("\n").replace(/\n+/,"\n").trim()}arrayFind(e,t){let s={},l=e.length;for(let t=0;t<l;t++)s[e[t]]=t;return s.hasOwnProperty(t)?s[t]:-1}escapeHtml(e){let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;","(":"&#40;",")":"&#41;"};return e.replace(/[&<>"'()]/g,(function(e){return t[e]}))}removeControlText(e){return e.replaceAll(/\r|\n|\t/g,"")}verifyFilename(e){return 0==e.trim().length?"":new URL(e,this.currentUrl().host).href.replaceAll(this.currentUrl().host,"")}getObjectType(e){return("object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&null!==e&&1===e.nodeType&&"string"==typeof e.nodeName)?"DOMobject":e.includes(this.openDelimiter)&&e.includes(this.closeDelimiter)?"template":e.includes(".html")?"html_path":e.includes(".css")?"css_path":"undefined"}}document.onmouseover=function(){window.innerDocClick=!0},document.onmouseleave=function(){window.innerDocClick=!1};