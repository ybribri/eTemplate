"use strict";class eTemplate{constructor({openDelimiter:e="<%",closeDelimiter:t="%>",syncClass:s="et_sync",startUrl:l="",urlList:r=[],useHash:n=!0,titleChange:i=!0,metaChange:o=!0,cssChange:c=!0}={}){this.startUrl=l,this.syncClass=s,this.openDelimiter=e,this.closeDelimiter=t,this.commentDelimiter=e+"%",this.htmlCode=[],this.htmlType=[],this.htmlSync=[],this.cssRules=[],this.cssCode=[],this.cssType=[],this.syncCnt=0,this.templateInClass=[],this.titleCode="",this.metaArray=[],this.urlList=r,this.preRead=[],this.scripts=[],this.options={useHash:n,titleChange:i,metaChange:o,cssChange:c}}async render({url:e="",scroll:t={}}={},s=(()=>{})){"function"==typeof arguments[0]&&(s=arguments[0]);const l=window.location.hash.substring(1);e=this.options.useHash?""!==e?e:""!==l?l+".html":""!==this.startUrl?this.startUrl:this.currentUrl().filename:""!==e?e:""!==this.startUrl?this.startUrl:this.currentUrl().filename,e=this.verifyFilename(e),this.urlList=this.urlList.map((e=>this.verifyFilename(e)));const r=this.urlList.indexOf(e)||0;let n="";if(this.syncCnt=0,0==this.preRead.length){let t=this.options;t.openDelimiter=this.openDelimiter,t.closeDelimiter=this.closeDelimiter,this.urlList.length>0&&this.preReadFiles(this.urlList,t);const s=this.currentUrl().host+e,l=await fetch(s),r=await l.text();this.options.metaChange&&(this.readMeta(r),this.changeMeta()),this.options.titleChange&&(this.getTitle(r),this.changeTitle(this.titleCode));const i=await this.readFurther(r);n=i.htmlBlock.join("")+this.scripts.join(""),this.htmlCode=i.OBJ_CODE.code,this.htmlType=i.OBJ_CODE.type}else{const e=this.preRead[r].fileIncludedHTML,t=this.preRead[r].cssText;this.titleCode=this.preRead[r].titleCode,this.metaArray=this.preRead[r].metaArray,this.templateInClass=[],this.syncCnt=0,this.options.metaChange&&this.changeMeta(),this.options.titleChange&&this.changeTitle(this.titleCode),this.options.cssChange&&this.changeCssFromCombinedStyle(t);const s=this.insertModules(e),l=await this.readFurtherFromCombinedHTML(s);n=l.htmlBlock.join(""),this.htmlCode=l.OBJ_CODE.code,this.htmlType=l.OBJ_CODE.type}if(this.removeAllChildNodes(document.querySelector("body")),document.body.insertAdjacentHTML("afterbegin",n),t!={}&&0!=Object.keys(t).length){const e=document.getElementById(t.id),s=["start","center","end"].some((e=>e==t.position));t.position=s?t.position:"center",null!==e&&e.scrollIntoView({block:t.position})}return document.body.style.display="block",s(),new Promise(((e,t)=>{e("done")}))}async preReadFiles(e,t){let s=[];for(let l=0;l<e.length;l++){const r=new URL(e[l],this.currentUrl().host).href;s[l]=new Worker(this.currentUrl().host+"js/worker.min.js"),s[l].postMessage({path:r,options:t}),s[l].onmessage=e=>{this.preRead[l]=e.data,s[l].terminate()}}}storeScript(e){const t=e.match(/<body*?>(\n|\r|\t|.)*/gm);if(null===t)return e;const s=t[0].match(/<script[\s\S]*?>[\s\S]*?<\/script>/gm,"");return null===s||(s.forEach((t=>e=e.replace(t,""))),this.scripts=s),e}async readFurther(e){e=this.removeComment(e),e=this.storeScript(e),this.options.cssChange&&await this.changeCss(e);const{fileIncludedHTML:t}=await this.insertNestedHTML(e),s=this.insertModules(t);let{types:l,codes:r}=this.seperateCode(s,"second"),n=this.makeSyncBlock(l,r);"JS"==l[0]&&(l.unshift("HTML"),r.unshift(" "),n=n.map((e=>e+1)),n.unshift(0));const i=this.insertSync(l,r,n);this.htmlSync=n,this.syncCnt=i.syncCnt;const o=this.interpret(l,r);return new Promise(((e,t)=>{e({htmlBlock:o,OBJ_CODE:i})}))}async readFurtherFromCombinedHTML(e){const t=this.insertModules(e);let{types:s,codes:l}=this.seperateCode(t,"second"),r=this.makeSyncBlock(s,l);"JS"==s[0]&&(s.unshift("HTML"),l.unshift(" "),r=r.map((e=>e+1)),r.unshift(0));const n=this.insertSync(s,l,r);this.htmlSync=r,this.syncCnt=n.syncCnt;return{htmlBlock:this.interpret(s,l),OBJ_CODE:n}}sync(){const e=this.syncClass;this.options.metaChange&&this.changeMeta(),this.options.titleChange&&this.changeTitle(this.titleCode);const t=document.querySelectorAll(`input.${e}`);for(let e=0;e<t.length;e++){const s=t[e];let l=s.getAttribute("data-sync");if(null==l)continue;let r="number"==s.type?"":'"';l+="="+(s.value?`${r}${this.escapeHtml(s.value)}${r};`:'"";');try{this.controlCode(l)}catch(e){return e}}let s=this.interpretPart(this.htmlType,this.htmlCode);const l=document.querySelectorAll(`.${e}`);for(let t=0;t<l.length;t++){let r=l[t];const n=[...r.classList],i=void 0!==n.find((t=>t.startsWith(e+"_"))),o=n.find((t=>t.startsWith(e+"Cnt"))),c=void 0!==o?parseInt(o.replace(`${e}Cnt`,""),10):0;if(i)for(let e=0;e<s[c].length;e++){let t="";if(this.templateInClass[c][e][1]!=s[c][e])if("class"==this.templateInClass[c][e][0])r.classList.remove(this.templateInClass[c][e][1]),r.classList.add(s[c][e]),this.templateInClass[c][e][1]=s[c][e];else if(this.templateInClass[c][e][0].includes("data-")){const l=this.templateInClass[c][e][0].substring(this.templateInClass[c][e][0].INDEXOf("data-")+5);t=r.dataset[l],t=t.replace(this.templateInClass[c][e][1],s[c][e]),r.dataset[l]=t,this.templateInClass[c][e][1]=s[c][e]}else t=r.getAttribute(this.templateInClass[c][e][0]),t=t.replace(this.templateInClass[c][e][1],s[c][e]),r.setAttribute(this.templateInClass[c][e][0],t),this.templateInClass[c][e][1]=s[c][e]}else{if(r.innerHTML==s[c])continue;this.removeAllChildNodes(r),r.insertAdjacentHTML("afterbegin",s[c])}}this.options.cssChange&&this.syncCss()}syncCss(){if(0==this.cssType.length||!this.cssType.includes("JS"))return;const e=this.interpret(this.cssType,this.cssCode),t=this.parseCSS(e.join(""));let s=0;for(let e=0;e<document.styleSheets.length;e++)if(null==document.styleSheets[e].href){s=e;break}const l=/\s+|\\n/g,r=this.cssRules,n=r.length;let i="",o=[],c=[];const h=t.length;for(let e=0;e<h;e++){const h=t[e],a=null==h.type?"":h.type;let u=-1,p=0,d="";switch(a){case"keyframes":for(let e=0;e<n;e++){let t=r[e],s=h.styles.substring(0,h.styles.indexOf("{")).trim(),l=t.styles.substring(0,t.styles.indexOf("{")).trim();if("keyframes"==t.type&&s==l){u=e;break}}if(-1==u){o.push(["rule",e,-1,-1,h.styles]);break}let t=r[u].styles,m=h.styles;t.replace(l,"")!=m.replace(l,"")&&(document.styleSheets[s].deleteRule(u),document.styleSheets[s].insertRule(m,u)),c.push([u,-2,0,7]);break;case"media":case"supports":p="media"==a?4:12;for(let e=0;e<n;e++){let t=r[e];if(t.type==a&&h.selector==t.selector){u=e;break}}if(-1==u){i=h.selector+" {\n";let t=h.subStyles.length;for(let e=0;e<t;e++){let t=h.subStyles[e];i+="    "+t.selector+" {\n";let s=t.rules.length;for(let e=0;e<s;e++)i+=`        ${t.rules[e].key}: ${t.rules[e].value};\n`;i+="    }\n"}i+="}\n",o.push(["rule",e,-1,-1,i]);break}for(let t=0;t<h.subStyles.length;t++){let l=h.subStyles[t];d=l.selector;let n=-1,a=r[u].subStyles.length;for(let e=0;e<a;e++)if(r[u].subStyles[e].selector==d){n=e;break}if(-1!=n)for(let i=0;i<l.rules.length;i++){let h=l.rules[i],a=-1,d=r[u].subStyles[n].rules.length;for(let e=0;e<d;e++){if(r[u].subStyles[n].rules[e].key==h.key){a=e;break}}if(-1==a){o.push(["style",e,t,i,h.key,h.value]);continue}const m=r[u].subStyles[n].rules[a].key,y=r[u].subStyles[n].rules[a].value,f=h.value;y!=f&&document.styleSheets[s].cssRules[u].cssRules[n].style.setProperty(m,f),c.push([u,n,a,p])}else{i="    "+l.selector+" {\n";for(let e=0;e<l.rules.length;e++)i+=`        ${l.rules[e].key}: ${l.rules[e].value};\n`;i+="    }\n",o.push(["rule",e,t,-1,i])}}break;case"":case"font-face":p="font-face"==a?5:1;const y=h.rules.length;for(let t=e;t<n;t++){const e=r[t];if(h.selector==e.selector){u=t;break}}if(-1==u){i=h.selector+" {\n";for(let e=0;e<y;e++)i+=`    ${h.rules[e].key}: ${h.rules[e].value};\n`;i+="}\n",o.push(["rule",e,-1,-1,i]);break}for(let t=0;t<y;t++){const l=h.rules[t];let n=-1;const a=r[u].rules.length;for(let e=0;e<a;e++){if(r[u].rules[e].key==l.key){n=e;break}}if(-1==n){i=`    ${l.key}: ${l.value};\n`,o.push(["style",e,-1,t,l.key,l.value]);continue}const d=r[u].rules[n].key,m=r[u].rules[n].value,y=l.value;m!=y&&document.styleSheets[s].cssRules[u].style.setProperty(d,y),c.push([u,-1,n,p])}}}let a=0,u=0;for(let e=r.length-1;e>=0;e--){let t=0;const l=r[e];switch(l.type){case"media":case"supports":t="media"==l.type?4:12,a=l.subStyles.length;for(let r=a-1;r>=0;r--){u=l.subStyles[r].rules.length;for(let n=u-1;n>=0;n--){if(this.arrayFind(c,[e,r,n,t])<0){let t=l.subStyles[r].rules[n].key;document.styleSheets[s].cssRules[e].cssRules[r].style.removeProperty(t)}}0==document.styleSheets[s].cssRules[e].cssRules[r].style.length&&document.styleSheets[s].cssRules[e].deleteRule(r)}0==document.styleSheets[s].cssRules[e].cssRules.length&&document.styleSheets[s].deleteRule(e);break;case"":case"font-face":t=""==l.type?1:5,u=l.rules.length;for(let r=u-1;r>=0;r--){if(this.arrayFind(c,[e,-1,r,t])<0){let t=l.rules[r].key;document.styleSheets[s].cssRules[e].style.removeProperty(t)}}0==document.styleSheets[s].cssRules[e].style.length&&document.styleSheets[s].deleteRule(e);break;case 7:this.arrayFind(c,[e,-2,0,7])<0&&document.styleSheets[s].deleteRule(e)}}let p=o.length;for(let e=0;e<p;e++){let[t,l,r,n,i,c=""]=o[e];if("style"==t)-1==r?document.styleSheets[s].cssRules[l].style.setProperty(i,c):document.styleSheets[s].cssRules[l].cssRules[r].style.setProperty(i,c);else{if(-1!=r){document.styleSheets[s].cssRules[l].insertRule(i,r);continue}document.styleSheets[s].insertRule(i,l)}}this.cssRules=JSON.parse(JSON.stringify(t))}findInclude(e){const t=/< *?body *?>[\s\S]*?< *?\/ *?body>/g,s=/ *?include\( *?["'`](.*?)["'`] *?\)/g,l=/ *?include\( *?["'`]/g,r=/["'`] *?\).*/g;let n=[],i=[];const o=null===e.match(t)?e:e.match(t)[0].replace(/< *?body *?>/g,"").replace(/< *?\/ *?body *?>/g,"");let{codes:c,types:h}=this.seperateCode(o,"first");const a=h.length,u=this.currentUrl().host;for(let e=0;e<a;e++)if("JS"==h[e]&&s.test(c[e])){const t=c[e].match(s)[0].replace(l,"").replace(r,"");n.push(new URL(t,u).href),i.push(e)}return{urls:n,orders:i,codes:c}}async insertNestedHTML(e,t=[]){let s="",{urls:l,orders:r,codes:n}=this.findInclude(e,t);if(0==l.length)return s=this.removeComment(n.join("")),{fileIncludedHTML:s,codes:n};let i=[];l.forEach((e=>i.push(this.getComparedPath(e,this.currentUrl().host))));let o=await this.getTextFromFiles(l);for(let e=0;e<o.length;e++)o[e]=this.htmlReplaceRelativeUrl(o[e],i[e]);return o.forEach(((e,t)=>n[r[t]]=e)),s=this.removeComment(n.join("")),await this.insertNestedHTML(s,i)}insertModules(e){const t=/<%#.*?%>/g,s=/<%# */g,l=/ *%>/g;let{types:r,codes:n}=this.seperateCode(e,"first"),i=0;const o=r.length;for(let e=0;e<o;e++)if("JS"==r[e]&&n[e].includes("<%#")){const r=" "+n[e].match(t)[0].replace(s,"").replace(l,"");try{n[e]=this.basicCode(r),i++}catch{n[e]='<%= "invalid module" %>',i++}}let c=n.join("");return 0!==i&&(c=this.insertModules(c)),c}seperateCode(e,t){const s=`(${this.openDelimiter}[^%][\\s\\S]*?${this.closeDelimiter})`,l=new RegExp(s,"g");let r=e.split(l),n=[];const i=r.length;for(let e=0;e<i;e++){const s=r[e],i=l.test(s)?"JS":"HTML";r[e]="JS"===i&&"second"===t?s.substring(2,s.length-2).trim():s,n.push(i)}const o=n.length;if(o>1)for(let e=o-1;e>=1;e--)n[e]==n[e-1]&&"HTML"==n[e]&&(r[e-1]=r[e-1]+r[e],r.splice(e,1),n.splice(e,1));return{types:n,codes:r}}interpret(e,t){let s=[],l=0;const r=this.escapeHtml(this.commentDelimiter.replace(this.commentDelimiter,this.openDelimiter)),n=this.escapeHtml(this.closeDelimiter),i=t.length;for(;l<i;){switch(e[l]){case"HTML":s.push(t[l].replaceAll(this.commentDelimiter,r).replaceAll(this.closeDelimiter,n));break;case"JS":if(0==t[l].search(/=|-/g)){try{s.push(this.basicCode(t[l]))}catch(e){s.push("invalid template")}break}{let r=this.eachBlock(e,t,l);l=r.index;try{s.push(this.controlCode(r.partBlock))}catch(e){s.push("invalid template")}break}}l++}return s}interpretPart(e,t){let s=[],l=-1,r=-1;for(let n=0;n<t.length;n++){const i=t[n],o=e[n],c=this.htmlSync[n];if(c!=r&&"JS"==o&&(l++,r=c),"HTML"==o)continue;if(0==i.search(/=|-/g)){if(null==this.templateInClass[l]){try{s.push(this.basicCode(i))}catch(e){s.push("invalid template script")}continue}try{this.htmlSync[n]!=this.htmlSync[n-1]?s.push([this.basicCode(i)]):s[s.length-1].push(this.basicCode(i))}catch(e){s.push("invalid template script")}continue}const h=this.eachBlock(e,t,n);n=h.index;try{s.push(this.controlCode(h.partBlock))}catch(e){s.push("invalid template script")}}return s}makeSyncBlock(e,t){let s=[],l=0,r=0,n=0;const i=t.length;for(let o=0;o<i;o++){switch(e[o]){case"HTML":s.push(l);break;case"JS":if(0==t[o].search(/=|-/g)){s.push(l);break}{let i=this.findBlockEnd(e,t,o);r=i.index,n=i.braceBalance,n<0?console.log("ERROR: missing {"):n>0&&console.log("ERROR: missing }"),s=[...s,...Array(r-o+1).fill(l)],o=r;break}}l++}return s}findBlockEnd(e,t,s){let l=0,r=0,n=t.length;for(r=s;r<n;r++)if(r!=s||"JS"!=e[r]){if("HTML"!=e[r]&&"JS"==e[r]&&0!==t[r].search(/=|-/g)&&(t[r].includes("{")&&l++,t[r].includes("}")&&l--,0==l))return{index:r,error:0}}else if(t[r].includes("{")&&l++,t[r].includes("}")&&l--,0==l)return{index:r,error:0};return 0!=l?{index:s,braceBalance:l}:{index:r,braceBalance:l}}eachBlock(e,t,s){let l="",r=0;const n=t.length;let i=0;for(i=s;i<n;i++){if(i==s){if("JS"==e[i]){if(t[i].includes("{")&&r++,t[i].includes("}")&&r--,0==r)return{partBlock:t[i],index:i};l=`let eTemplateInterpreted=${String.fromCharCode(96)}${String.fromCharCode(96)}; ${t[i]}`;continue}l=`let eTemplateInterpreted=${String.fromCharCode(96)}${t[i]}${String.fromCharCode(96)};`}switch(e[i]){case"HTML":""!==this.removeControlText(t[i]).trim()&&(l+=`eTemplateInterpreted += ${String.fromCharCode(96)}${t[i]}${String.fromCharCode(96)};`);continue;case"JS":if(0==t[i].search(/=|-/g))l+=`eTemplateInterpreted += ${t[i].substring(1)};`;else if(l+=t[i],t[i].includes("{")&&r++,t[i].includes("}")&&r--,0==r)return l+="; return eTemplateInterpreted;",{partBlock:l,index:i}}}return l+="; return eTemplateInterpreted;",{partBlock:l,index:i}}insertSync(e,t,s){let l=-1,r=0,n=0,i=0,o="",c="",h="",a=0,u=0,p=0,d=[],m=this.syncCnt;const y=s.length,f=this.syncClass,g=/[\s]+((-|\w)+) *= *["']/g,C=/[\s\S]+class[\s]*= *["']/g;for(let S=0;S<y;S++){if("JS"==e[S]&&(t[S]=t[S].trim()),s[S]==l||"JS"!=e[S]){l=s[S];continue}l=s[S],p=0,a=S,u=s.lastIndexOf(s[a]),h=t[S-1],d=[];const b=this.removeControlText(h),T=b.length-b.trimEnd().length;if(">"==b.substring(b.length-T-1).trim())if(r=h.lastIndexOf("<"),n=h.lastIndexOf(">"),i=h.indexOf(" ",r),c=-1==i||i>n?h.substring(r+1,n):h.substring(r+1,h.length).split(" ")[0],"</"!=h.substring(r,r+2))if(t[u+1].includes("</"+c)&&t[u+1].indexOf("</"+c)<(-1==t[u+1].indexOf("<"+c)?t[u+1].length:t[u+1].indexOf("<"+c))){if(0==this.removeControlText(t[u+1]).trim().indexOf("</"+c)){if(n=h.length,r=h.lastIndexOf("<"),o=h.substring(r,n),o.includes("class=")){p=h.indexOf("class=",r)+7,t[S-1]=`${h.substring(0,p)}${f} ${f}Cnt${m} ${h.substring(p)}`,m++;continue}n=h.lastIndexOf(">"),t[S-1]=`${h.substring(0,n)} class="${f} ${f}Cnt${m}" ${h.substring(n,h.length)}`,m++;continue}r=0,n=t[u+1].indexOf("</"),t[S-1]=`${t[S-1]}<span class="${f} ${f}Cnt${m}">`,m++,t[u+1]=`</span>${t[u+1]}`}else t[S-1]=`${t[S-1]}<span class="${f} ${f}Cnt${m}">`,m++,t[u+1]=`</span>${t[u+1]}`;else t[S-1]=`${t[S-1]}<span class="${f} ${f}Cnt${m}">`,m++,t[u+1]=`</span>${t[u+1]}`;else{if(n=h.lastIndexOf(">"),r=h.lastIndexOf("<"),n<r){for(let l=S+1;l<y;l++)if("HTML"===e[l]&&t[l].indexOf(">")>0){for(let e=S+1;e<l;e++)s[e]=s[S];u=s.lastIndexOf(s[S]);break}let l=-1,i="";for(let s=S;s<=u;s++)if("JS"===e[s]){for(let e=s-1;e>=0;e--){let s=[...t[e].matchAll(g)];if(s.length>0){i=s[s.length-1][1],"class"==i&&(l=e);break}}""!=i&&d.push(i)}for(let s=S-1;s<=u+1;s++)if("HTML"===e[s]&&null!==t[s].match(g)&&"JS"==e[s+1]){let e=t[s].lastIndexOf("class");if(s==S-1&&e>r){l=s;break}if(s>S&&e<t[s].indexOf(">")){l=s;break}}const o=[...new Set(d)].join("+");let c=[];for(let s=S;s<=u;s++)"JS"==e[s]&&c.push(this.basicCode(t[s].substring(1)));if(d.length>0&&(this.templateInClass[m]=[],d.map(((e,t)=>{this.templateInClass[m].push([e,c[t]])}))),-1===l)r=h.lastIndexOf("<"),n=h.indexOf(" ",r),t[S-1]=`${h.substring(0,n+1)} class="${f} ${f}_${o} ${f}Cnt${m}" ${h.substring(n+1)}`,m++;else{let e=t[l].match(C)[0],s=t[l].replace(e,"");t[l]=`${e}${f} ${f}_${o} ${f}Cnt${m} ${s}`,m++}continue}t[S-1]+=`<span class="${f} ${f}Cnt${m}">`,m++,t[u+1]="</span>"+t[u+1]}}return{type:e,code:t,syncCnt:m}}getTitle(e){const t=/<head>[\s\S]*?<\/head>/g,s=/<title>[\s\S]*?<\/title>/g,l=null==e.match(t)?"":e.match(t)[0],r=null==l.match(s)?"":l.match(s)[0].replace("<title>","").replace("</title>","").trim();this.titleCode=r.length>0?r:this.titleCode}changeTitle(e){const t=`${this.openDelimiter}[^%][\\s\\S]*?${this.closeDelimiter}`,s=new RegExp(t,"g");let l=null,r=e;null!=e.trim().match(s)&&(l=e.trim().match(s)[0].replaceAll(`${this.openDelimiter}`,"").replaceAll(`${this.closeDelimiter}`,""),r=this.basicCode(l)),document.querySelector("title")&&(document.querySelector("title").innerHTML=r)}readMeta(e){const t=document.createElement("document");t.insertAdjacentHTML("beforeend",e);const s=t.querySelectorAll("meta");let l=[];s.forEach(((e,t)=>{for(let s=0;s<e.attributes.length;s++)e.attributes[s].value.indexOf(this.openDelimiter)>-1&&l.push({metaNo:t,attributeNo:s,nodeName:e.attributes[s].name,nodeValue:e.attributes[s].value})})),this.metaArray=JSON.parse(JSON.stringify(l))}changeMeta(){if(0==this.metaArray.length)return;const e=`(${this.openDelimiter}[^%][\\s\\S]*?${this.closeDelimiter})`,t=new RegExp(e,"g");let s=document.querySelectorAll("meta");this.metaArray.forEach((e=>{let l=e.nodeValue.split(t),r=!1;for(let e=0;e<l.length;e++){if(-1==l[e].indexOf(this.openDelimiter))continue;let t=l[e].replace(this.openDelimiter,"").replace(this.closeDelimiter,"").trim(),s=this.basicCode(t.substring(1));l[e]=s,r=!0}r&&(s[e.metaNo].attributes[e.attributeNo].nodeValue=l.join(""))}))}removeComment(e){return e.replace(/<!--[\s\S]*?-->/gm,"")}async changeCss(e){e=this.removeComment(e);let t=await this.combineCss(e);t=this.changeNestingPattern(t),this.changeCssFromCombinedStyle(t)}changeCssFromCombinedStyle(e){const{types:t,codes:s}=this.seperateCode(e,"second");this.cssCode=s,this.cssType=t;e=this.interpret(t,s).join("");const l=this.parseCSS(e);this.cssRules=l;const r=this.createTextStyle(l);if(""==r)return;document.querySelectorAll("style").forEach((e=>e.parentNode.removeChild(e)));const n=document.createElement("style");n.appendChild(document.createTextNode(r)),document.head.appendChild(n),document.head.querySelectorAll("link").forEach((e=>{"stylesheet"==e.getAttribute("rel")&&e.getAttribute("href").indexOf("http")<0&&e.parentNode.removeChild(e)}))}async combineCss(e){let t=[],s=[];const l=e.indexOf("<head>"),r=e.indexOf("</head>");if(-1==l||-1==r)return"";e.replace(/<style>[\s\S]*?<\/style>/gi,(function(e){return s.push(e.replaceAll("<style>","").replaceAll("</style>","")),""}));let n=s.join(""),i=[];e.replace(/<link.*?rel="stylesheet"[\s\S]*?\/?>/gi,(function(e){return i.push(e),""}));const o=this.currentUrl().host;i.forEach((e=>{const s=e.match(/href=".*?"/gi)[0].replaceAll("href=","").replaceAll('"',"");s.indexOf("http")<0&&t.push(new URL(s,o).href)})),t=t.map((e=>this.removeControlText(e)));let c=await this.getTextFromFiles(t),h=[];t.forEach((e=>{h.push(this.getComparedPath(e,this.currentUrl().host))}));for(let e=0;e<c.length;e++)c[e]=this.replaceRelativeUrl(c[e],h[e]);return n+=c.join(""),n=await this.insertNestedCSS(n),n}getOnlyPath(e){let t=e.split("/");return t.pop(),t.join("/")}splitUrl(e){let t=e.split("/");return""==t[t.length-1]&&t.pop(),""==t[0]&&t.shift(),t}getRelativeUrl(e){const t=this.currentUrl().host,s=this.splitUrl(t);let l=this.splitUrl(e),r=[];for(let e=0;e<s.length;e++)s[e]!==l[e]?r.push(".."):l[e]=".";l=[...r,...l];for(let e=0;e<l.length;e++)"."==l[e]&&"."==l[e+1]&&(l[e]="_erase_");for(let e=l.length-1;e>=0;e--)("_erase_"==l[e]||"."==l[e]&&e>0)&&l.splice(e,1);return"/"+l.join("/")+"/"}getComparedPath(e,t){e=this.getOnlyPath(e),e=this.getRelativeUrl(e),t=this.getRelativeUrl(t);let s=this.splitUrl(e),l=this.splitUrl(t),r=[];for(let e=0;e<l.length;e++)l[e]!==s[e]?""!==l[e]&&r.push(".."):s[e]=".";return s=[...r,...s],s.join("/")+"/"}replaceRelativeUrl(e,t){function s(e,s,l,r,n,i,o){return null==s?n+(i=this.compareUrls(i,t))+o:s+(l=this.compareUrls(l,t))+r}if(s=s.bind(this),e.includes("base64,")||e.includes("http"))return e;return e.replace(/(@import *['"])(.*?)(['"])|(@import *url\(['"]?)(.*?)(['"]?\))/g,s)}htmlReplaceRelativeUrl(e,t){const s=`(\\<[a-z]* *src *= *['"])((?!http|${this.openDelimiter}).*)(['"])|(href *= *['"])((?!http|${this.openDelimiter}|#).*[^\\>\\%])(['"])|(${this.openDelimiter}[^\\%] *include *\\(?["'])(.*)(["'])`,l=new RegExp(s,"g");function r(e,s,l,r,n,i,o,c,h,a){return void 0!==s?s+(l=this.compareUrls(l,t))+r:void 0!==n?n+(i=this.compareUrls(i,t))+o:c+(h=this.compareUrls(h,t))+a}return r=r.bind(this),e.replace(l,r)}compareUrls(e,t){if(!e.includes("/"))return t+e;if("/"==e.substring(0,1))return t+e.substring(1);if("./"==e.substring(0,2))return t+e.substring(2);if("../"==e.substring(0,3)){let s=[...e.matchAll(/\.\.\//g)].length,l=t.split("/");for(l.pop();l.length>=0&&s>0;)l.pop(),s--;return(t="."+l.join("/")+"/")+e.substring(3)}}async insertNestedCSS(e){let{urls:t,orders:s,codes:l,media:r}=this.findImport(e);if(0==t.length)return l.join("");let n=await this.getTextFromFiles(t),i=[];t.forEach((e=>{i.push(this.getComparedPath(e,this.currentUrl().host))}));for(let e=0;e<n.length;e++)n[e]=this.replaceRelativeUrl(n[e],i[e]);return n.forEach(((e,t)=>{l[s[t]]=""!==r[t]?this.insertMedia(e,r[t]):e})),await this.insertNestedCSS(l.join(""))}insertMedia(e,t){return`@media ${t} { ${e} }`}findImport(e){const t=/(@import *?(?:url)?\(?["'].*["']\)? *?.*;)/g,s=/[^(?:\.)|(?:\.\/)].*/g;let l=[],r=[],n=[],i=0,o=e.split(t),c=[...e.matchAll(/@import *?(url)?\(?["'](.*)["']\)? *?(.*);/g)];for(let e=0;e<o.length;e++)-1==o[e].search(t)||o[e].includes("http")?o[e]=this.removeControlText(o[e]).trim():(n[i]=e,i++);return c.forEach((e=>{const t=e[2].match(s)[0].trim();l.push(this.currentUrl().host+t),r.push(null===e[3]?"":e[3].trim())})),{urls:l,orders:n,codes:o,media:r}}createTextStyle(e){let t="";const s=e.length;for(let l=0;l<s;l++){const s=e[l];switch(null==s.type?"":s.type){case"":case"font-face":t=t+s.selector+" {\n",s.rules.forEach((e=>{t+=`    ${e.key}: ${e.value};\n`})),t+="}\n";break;case"imports":case"keyframes":t+=s.styles.replaceAll("{","{\n").replaceAll("}","}\n").replaceAll(";",";\n")+"\n";break;case"supports":case"media":t+=s.selector+" {\n",s.subStyles.forEach((e=>{t+="    "+e.selector+" {\n",e.rules.forEach((e=>{t+=`        ${e.key}: ${e.value};\n`})),t+="    }\n"})),t+="}\n"}}return t}changeNestingPattern(e){let t=this.getStyle(e);return t=this.getSub(t),this.makeStyle(t)}makeStyle(e){let t="";for(let s=0;s<e.length;s++)t+=`${e[s].selector} {\n ${e[s].styleText}\n}\n`;return t}getSub(e){let t=!1;for(let s=e.length-1;s>=0;s--){if(Array.isArray(e[s].styleText)){e[s].styleText=this.makeStyle(this.getSub(e[s].styleText));continue}let l=e[s].styleText;const r=this.getInfo(l);for(let n=r.length-1;n>=0;n--){let i=l.substring(r[n].selectorStart,r[n].selectorEnd+1).trim();i=i.replaceAll("&",e[s].selector);const o=l.substring(r[n].styleStart+1,r[n].styleEnd).trim(),c=l.substring(r[n].selectorStart,r[n].styleEnd+1);e.splice(s+1,0,{selector:i,styleText:o}),l=l.replace(c,""),t=!0}e[s].styleText=l}return t?this.getSub(e):e}getInfo(e){let t=[],s=-1,l=-1,r=-1,n=-1,i=0;for(let o=0;o<e.length;o++){const c=i,h=e[o];-1===s&&"&"===h&&(s=o),-1!==s&&"{"===h&&(-1===r&&(r=o,l=o-1),i++),-1!==r&&"}"===h&&i--,i!==c&&0===i&&(n=o,t.push({selectorStart:s,selectorEnd:l,styleStart:r,styleEnd:n}),s=-1,l=-1,r=-1,n=-1)}return t}getStyle(e){let t=[],s="",l="",r=0,n=0;const i=new Map([["{",1],["}",-1]]);for(let o=0;o<e.length;o++){const c=e[o];n=r,r+=void 0===i.get(c)?0:i.get(c),l+=c,n!==r&&0===r&&(s.includes("@media")||s.includes("@supports")?t.push({selector:s,styleText:this.getStyle(l.substring(0,l.length-1).trim())}):t.push({selector:s,styleText:l.substring(0,l.length-1).trim()}),l="",s=""),0===n&&1===r&&(s=l.substring(0,l.length-1).trim(),l="")}return t}async renderPart(e="",t=""){let s="",l=[],r=[];if(""==t.trim())return"select type from html, html_path";if(""==e.trim())return"nothing to render";switch(t){case"HTML":s=e;const{fileIncludedHTML:t}=await this.insertNestedHTML(s),n=this.insertModules(t);l=this.seperateCode(n,"second"),r=this.makeSyncBlock(l.types,l.codes),"JS"==l.types[0]&&(l.types.unshift("HTML"),l.codes.unshift(" "),r=r.map((e=>e+1)),r.unshift(0)),l=this.insertSync(l.types,l.codes,r),this.syncCnt=l.syncCnt;return{domText:this.interpret(l.type,l.code).join(""),sourceType:l.type,sourceCode:l.code,sourceSync:r};case"CSS":s=e,s=await this.insertNestedCSS(s),l=this.seperateCode(s,"second");const i=this.interpret(l.type,l.code).join(""),o=this.parseCSS(i);return{cssText:this.createTextStyle(o),cssRules:o,cssType:l.type,cssCode:l.code}}}async appendHTML(e="",t){if(""==e)return"nothing to append";let s=await this.renderPart(e,"HTML"),l=s.domText||"";if(null==t)return"no element to append to";const r=s.sourceType||[],n=s.sourceCode||[],i=s.sourceSync||[];return"DOMobject"!=this.getObjectType(t)?"invalid element to append into":0==r.length?"nothing to append":(this.htmlType=[...this.htmlType,...r],this.htmlCode=[...this.htmlCode,...n],this.htmlSync=[...this.htmlSync,...i],l=l.trim(),""==l?"nothing to append":(t.insertAdjacentHTML("beforeend",l),"success"))}async appendCSS(e=""){if(""==e)return;let t=await this.renderPart(e,"CSS");const s=t.cssText||"";let l,r=t.cssRules||[],n=t.cssType||[],i=t.cssCode||[];return null==document.querySelector("style")?(l=document.createElement("style"),l.appendChild(document.createTextNode(s)),document.head.appendChild(l),this.cssRules=[...this.cssRules,...r],this.cssType=[...this.cssType,...n],this.cssCode=[...this.cssCode,...i],"success"):(l=document.createTextNode(s),document.querySelector("style").appendChild(l),this.cssRules=[...this.cssRules,...r],this.cssType=[...this.cssType,...n],this.cssCode=[...this.cssCode,...i],"success")}basicCode(e){try{return Function(`"use strict"; return ( ${e.substring(1)} )`)()}catch(t){return console.log(e),console.error(t),"invalid template"}}controlCode(e){e=this.removeControlText(e);try{return Function(`"use strict"; ${e.replace(/[\n\r\t]/g,"")}`)()}catch(e){return console.error(e),"invalid template block"}}currentUrl(){const e=window.location.hash,t=window.location.href.replace(e,"");let s=t.split("/").pop();const l=t.substring(0,t.length-s.length);return""!==e&&this.options.useHash&&(s=e.substring(1)+".html"),{host:l,filename:s}}async getTextFromFiles(e){if(0==e.length)return[];const t=e.map((e=>fetch(e)));let s=await Promise.allSettled(t),l=[];s.map(((e,t)=>{e.value.ok||l.push(t)})),s=s.filter((e=>e.value.ok));const r=s.map((e=>e.value));s=await Promise.all(r);const n=s.map((e=>e.text()));let i=await Promise.all(n);return l.map((e=>i.splice(e,0,"error: check your path to include from"))),i}removeAllChildNodes(e){for(;e.firstChild;)e.removeChild(e.firstChild)}parseCSS(e){if(void 0===e)return[];const t=/@import .*?\(.*?\);/g,s=/((@keyframes[\s\S]*?){([\s\S]*?}\s*?)})/g;let l=[];const r=[...(e=e.replace(/\/\*.*?\*\//g,"")).matchAll(t)],n=r.length;for(let e=0;e<n;e++){const t=r[e];l.push({selector:"@imports",type:"imports",styles:t[0]})}const i=[...(e=e.replace(t,"")).matchAll(s)],o=i.length;for(let e=0;e<o;e++){const t=i[e];l.push({selector:"@keyframes",type:"keyframes",styles:t[0]})}const c=[...(e=e.replace(s,"")).matchAll(/((\s*?(?:\/\*[\s\S]*?\*\/)?\s*?(@media|@supports)[\s\S]*?){([\s\S]*?)}\s*?})|(([\s\S]*?){([\s\S]*?)})/g)],h=c.length;for(let e=0;e<h;e++){const t=c[e];let s=void 0===t[2]?t[6]:t[2];s=this.standardReturn(s);const r=s.includes("@media")?"media":s.includes("@supports")?"supports":"@font-face"===s?"font-face":"";let n={selector:s,type:r};"media"===r||"supports"===r?n.subStyles=this.parseCSS(t[4]+"\n}"):n.rules=this.parseRules(t[7]),l.push(n)}return l}parseRules(e){let t=[];const s=(e=this.standardReturn(e).split(";")).length;for(let l=0;l<s;l++){let s=e[l];if(s=s.trim(),s.includes(":")||"base64,"!==s.substring(0,7)){if(s.includes(":")){s=s.split(":");const e=s[0].trim(),l=s.slice(1).join(":").trim();e.length>0&&l.length>0&&t.push({key:e,value:l})}}else t[t.length-1].value+=s}return t}standardReturn(e){return e.split("\r\n").join("\n").replace(/\n+/,"\n").trim()}arrayFind(e,t){let s={};const l=e.length;for(let t=0;t<l;t++)s[e[t]]=t;return s.hasOwnProperty(t)?s[t]:-1}escapeHtml(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;","(":"&#40;",")":"&#41;"};return e.replace(/[&<>"'()]/g,(function(e){return t[e]}))}removeControlText(e){return e.replaceAll(/\r|\n|\t/g,"")}verifyFilename(e){return 0==e.trim().length?"":new URL(e,this.currentUrl().host).href.replaceAll(this.currentUrl().host,"")}getObjectType(e){return("object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&null!==e&&1===e.nodeType&&"string"==typeof e.nodeName)?"DOMobject":e.includes(this.openDelimiter)&&e.includes(this.closeDelimiter)?"template":e.includes(".html")?"html_path":e.includes(".css")?"css_path":"undefined"}}