"use strict";class eTemplate{constructor({openDelimiter:e="<%",closeDelimiter:t="%>",syncClass:s="et_sync",startUrl:l="",urlList:r=[],useHash:i=!0,titleChange:n=!0,metaChange:h=!0,cssChange:o=!0}={}){this.startUrl=l,this.syncClass=s,this.openDelimiter=e,this.closeDelimiter=t,this.commentDelimiter=e+"%",this.htmlCode=[],this.htmlType=[],this.htmlSync=[],this.cssRules=[],this.cssCode=[],this.cssType=[],this.syncCnt=0,this.templateInClass=[],this.titleCode="",this.metaArray=[],this.urlList=r,this.preRead=[],this.scripts=[],this.options={useHash:i,titleChange:n,metaChange:h,cssChange:o}}async render({url:e="",scroll:t={}}={},s=(()=>{})){"function"==typeof arguments[0]&&(s=arguments[0]);this.options.cssChange;const l=window.location.hash.substring(1);e=this.options.useHash?""!==e?e:""!==l?l+".html":""!==this.startUrl?this.startUrl:this.currentUrl().filename:""!==e?e:""!==this.startUrl?this.startUrl:this.currentUrl().filename,e=this.verifyFilename(e),this.urlList=this.urlList.map((e=>this.verifyFilename(e)));let r=this.urlList.indexOf(e)||0,i="";if(this.syncCnt=0,0==this.preRead.length){let t=this.options;t.openDelimiter=this.openDelimiter,t.closeDelimiter=this.closeDelimiter,this.urlList.length>0&&this.preReadFiles(this.urlList,t);let s=this.currentUrl().host+e;const l=await fetch(s),r=await l.text();this.options.metaChange&&(this.readMeta(r),this.changeMeta()),this.options.titleChange&&(this.getTitle(r),this.changeTitle(this.titleCode));const n=await this.readFurther(r);i=n.htmlBlock.join("")+this.scripts.join(""),this.htmlCode=n.codeList.code,this.htmlType=n.codeList.type}else{let e=this.preRead[r].fileIncludedHTML,t=this.preRead[r].cssText;this.titleCode=this.preRead[r].titleCode,this.metaArray=this.preRead[r].metaArray,this.templateInClass=[],this.syncCnt=0,this.options.metaChange&&this.changeMeta(),this.options.titleChange&&this.changeTitle(this.titleCode),this.options.cssChange&&this.changeCssFromCombinedStyle(t);let s=this.insertModules(e);const l=await this.readFurtherFromCombinedHTML(s);i=l.htmlBlock.join(""),this.htmlCode=l.codeList.code,this.htmlType=l.codeList.type}if(this.removeAllChildNodes(document.querySelector("body")),document.body.insertAdjacentHTML("afterbegin",i),t!={}&&0!=Object.keys(t).length){let e=document.getElementById(t.id),s=["start","center","end"].some((e=>e==t.position));t.position=s?t.position:"center",null!==e&&e.scrollIntoView({block:t.position})}return document.body.style.display="block",s(),new Promise(((e,t)=>{e("done")}))}async preReadFiles(e,t){let s=[];for(let l=0;l<e.length;l++){const r=new URL(e[l],this.currentUrl().host).href;s[l]=new Worker(this.currentUrl().host+"js/worker.min.js"),s[l].postMessage({path:r,options:t}),s[l].onmessage=e=>{this.preRead[l]=e.data,s[l].terminate()}}}storeScript(e){let t=[];this.scripts=t;let s=e.match(/<body*?>(\n|\r|\t|.)*/gm);return null===s?e:(t=s[0].match(/<script[\s\S]*?>[\s\S]*?<\/script>/gm,""),null===t||(t.forEach((t=>e=e.replace(t,""))),this.scripts=t),e)}async readFurther(e){e=this.removeComment(e),e=this.storeScript(e),this.options.cssChange&&await this.changeCss(e);let{fileIncludedHTML:t,codeList:s}=await this.insertNestedHTML(e),l=this.insertModules(t),{types:r,codes:i}=this.seperateCode(l,"second"),n=this.makeSyncBlock(r,i);"JS"==r[0]&&(r.unshift("HTML"),i.unshift(" "),n=n.map((e=>e+1)),n.unshift(0)),s=this.insertSync(r,i,n),this.htmlSync=n,this.syncCnt=s.syncCnt;let h=this.interpret(r,i);return new Promise(((e,t)=>{e({htmlBlock:h,codeList:s})}))}async readFurtherFromCombinedHTML(e){let t=this.insertModules(e),{types:s,codes:l}=this.seperateCode(t,"second"),r=this.makeSyncBlock(s,l);"JS"==s[0]&&(s.unshift("HTML"),l.unshift(" "),r=r.map((e=>e+1)),r.unshift(0));let i=this.insertSync(s,l,r);return this.htmlSync=r,this.syncCnt=i.syncCnt,{htmlBlock:this.interpret(s,l),codeList:i}}sync(){let e="",t=this.syncClass;new RegExp("${eClass}_");this.options.metaChange&&this.changeMeta(),this.options.titleChange&&this.changeTitle(this.titleCode);const s=document.querySelectorAll(`input.${t}`);for(let t=0;t<s.length;t++){let l=s[t];if(e=l.getAttribute("data-sync"),null==e)continue;let r="number"==l.type?"":'"';e+="="+(l.value?`${r}${this.escapeHtml(l.value)}${r};`:'"";');try{this.controlCode(e)}catch(e){return e}}let l=this.interpretPart(this.htmlType,this.htmlCode);const r=document.querySelectorAll(`.${t}`);for(let s=0;s<r.length;s++){let i=r[s],n=[...i.classList],h=void 0!==n.find((e=>e.startsWith(t+"_"))),o=n.find((e=>e.startsWith(t+"Cnt"))),a=void 0!==o?parseInt(o.replace(`${t}Cnt`,""),10):0;if(h){for(let t=0;t<l[a].length;t++)if(this.templateInClass[a][t][1]!=l[a][t])if("class"==this.templateInClass[a][t][0])i.classList.remove(this.templateInClass[a][t][1]),i.classList.add(l[a][t]),this.templateInClass[a][t][1]=l[a][t];else if(this.templateInClass[a][t][0].includes("data-")){let s=this.templateInClass[a][t][0].substring(this.templateInClass[a][t][0].indexOf("data-")+5);e=i.dataset[s],e=e.replace(this.templateInClass[a][t][1],l[a][t]),i.dataset[s]=e,this.templateInClass[a][t][1]=l[a][t]}else e=i.getAttribute(this.templateInClass[a][t][0]),e=e.replace(this.templateInClass[a][t][1],l[a][t]),i.setAttribute(this.templateInClass[a][t][0],e),this.templateInClass[a][t][1]=l[a][t]}else{if(i.innerHTML==l[a])continue;this.removeAllChildNodes(i),i.insertAdjacentHTML("afterbegin",l[a])}}this.options.cssChange&&this.syncCss()}syncCss(){if(0==this.cssType.length||!this.cssType.includes("JS"))return;let e=this.interpret(this.cssType,this.cssCode),t=this.parseCSS(e.join("")),s=0;for(let e=0;e<document.styleSheets.length;e++)if(null==document.styleSheets[e].href){s=e;break}const l=/\s+|\\n/g;let r=this.cssRules,i=r.length,n="",h=[],o=[],a=t.length;for(let e=0;e<a;e++){let a=t[e],c=null==a.type?"":a.type,u=-1,p=0,d="";switch(c){case"keyframes":for(let e=0;e<i;e++){let t=r[e],s=a.styles.substring(0,a.styles.indexOf("{")).trim(),l=t.styles.substring(0,t.styles.indexOf("{")).trim();if("keyframes"==t.type&&s==l){u=e;break}}if(-1==u){h.push(["rule",e,-1,-1,a.styles]);break}let t=r[u].styles,m=a.styles;t.replace(l,"")!=m.replace(l,"")&&(document.styleSheets[s].deleteRule(u),document.styleSheets[s].insertRule(m,u)),o.push([u,-2,0,7]);break;case"media":case"supports":p="media"==c?4:12;for(let e=0;e<i;e++){let t=r[e];if(t.type==c&&a.selector==t.selector){u=e;break}}if(-1==u){n=a.selector+" {\n";let t=a.subStyles.length;for(let e=0;e<t;e++){let t=a.subStyles[e];n+="    "+t.selector+" {\n";let s=t.rules.length;for(let e=0;e<s;e++)n+=`        ${t.rules[e].key}: ${t.rules[e].value};\n`;n+="    }\n"}n+="}\n",h.push(["rule",e,-1,-1,n]);break}for(let t=0;t<a.subStyles.length;t++){let l=a.subStyles[t];d=l.selector;let i=-1,c=r[u].subStyles.length;for(let e=0;e<c;e++)if(r[u].subStyles[e].selector==d){i=e;break}if(-1!=i)for(let n=0;n<l.rules.length;n++){let a=l.rules[n],c=-1,d=r[u].subStyles[i].rules.length;for(let e=0;e<d;e++){if(r[u].subStyles[i].rules[e].key==a.key){c=e;break}}if(-1==c){h.push(["style",e,t,n,a.key,a.value]);continue}let m=r[u].subStyles[i].rules[c].key,f=r[u].subStyles[i].rules[c].value,y=a.value;f!=y&&document.styleSheets[s].cssRules[u].cssRules[i].style.setProperty(m,y),o.push([u,i,c,p])}else{n="    "+l.selector+" {\n";for(let e=0;e<l.rules.length;e++)n+=`        ${l.rules[e].key}: ${l.rules[e].value};\n`;n+="    }\n",h.push(["rule",e,t,-1,n])}}break;case"":case"font-face":p="font-face"==c?5:1;for(let t=e;t<i;t++){let e=r[t];if(a.selector==e.selector){u=t;break}}if(-1==u){n=a.selector+" {\n";let t=a.rules.length;for(let e=0;e<t;e++)n+=`    ${a.rules[e].key}: ${a.rules[e].value};\n`;n+="}\n",h.push(["rule",e,-1,-1,n]);break}let f=a.rules.length;for(let t=0;t<f;t++){let l=a.rules[t],i=-1,c=r[u].rules.length;for(let e=0;e<c;e++){if(r[u].rules[e].key==l.key){i=e;break}}if(-1==i){n=`    ${l.key}: ${l.value};\n`,h.push(["style",e,-1,t,l.key,l.value]);continue}let d=r[u].rules[i].key,m=r[u].rules[i].value,f=l.value;m!=f&&document.styleSheets[s].cssRules[u].style.setProperty(d,f),o.push([u,-1,i,p])}}}let c=0,u=0;for(let e=r.length-1;e>=0;e--){let t=0,l=r[e];switch(l.type){case"media":case"supports":t="media"==l.type?4:12,c=l.subStyles.length;for(let r=c-1;r>=0;r--){u=l.subStyles[r].rules.length;for(let i=u-1;i>=0;i--){if(this.arrayFind(o,[e,r,i,t])<0){let t=l.subStyles[r].rules[i].key;document.styleSheets[s].cssRules[e].cssRules[r].style.removeProperty(t)}}0==document.styleSheets[s].cssRules[e].cssRules[r].style.length&&document.styleSheets[s].cssRules[e].deleteRule(r)}0==document.styleSheets[s].cssRules[e].cssRules.length&&document.styleSheets[s].deleteRule(e);break;case"":case"font-face":t=""==l.type?1:5,u=l.rules.length;for(let r=u-1;r>=0;r--){if(this.arrayFind(o,[e,-1,r,t])<0){let t=l.rules[r].key;document.styleSheets[s].cssRules[e].style.removeProperty(t)}}0==document.styleSheets[s].cssRules[e].style.length&&document.styleSheets[s].deleteRule(e);break;case 7:this.arrayFind(o,[e,-2,0,7])<0&&document.styleSheets[s].deleteRule(e)}}let p=h.length;for(let e=0;e<p;e++){let[t,l,r,i,n,o=""]=h[e];if("style"==t)-1==r?document.styleSheets[s].cssRules[l].style.setProperty(n,o):document.styleSheets[s].cssRules[l].cssRules[r].style.setProperty(n,o);else{if(-1!=r){document.styleSheets[s].cssRules[l].insertRule(n,r);continue}document.styleSheets[s].insertRule(n,l)}}this.cssRules=JSON.parse(JSON.stringify(t))}findInclude(e){const t=/< *?body *?>[\s\S]*?< *?\/ *?body>/g,s=/ *?include\( *?["'`](.*?)["'`] *?\)/g,l=/ *?include\( *?["'`]/g,r=/["'`] *?\).*/g;let i=[],n=[],h="",o="";o=null===e.match(t)?e:e.match(t)[0].replace(/< *?body *?>/g,"").replace(/< *?\/ *?body *?>/g,"");let{codes:a,types:c}=this.seperateCode(o,"first"),u=c.length,p=this.currentUrl().host;for(let e=0;e<u;e++)"JS"==c[e]&&s.test(a[e])&&(h=a[e].match(s)[0].replace(l,"").replace(r,""),i.push(new URL(h,p).href),n.push(e));return{urls:i,orders:n,codeList:a}}async insertNestedHTML(e,t=[]){let s="",{urls:l,orders:r,codeList:i}=this.findInclude(e,t);if(0==l.length)return s=this.removeComment(i.join("")),{fileIncludedHTML:s,codeList:i};let n=[];l.forEach(((e,t)=>{n.push(this.getComparedPath(e,this.currentUrl().host))}));let h=await this.getTextFromFiles(l);for(let e=0;e<h.length;e++)h[e]=this.htmlReplaceRelativeUrl(h[e],n[e]);return h.forEach(((e,t)=>{i[r[t]]=e})),s=this.removeComment(i.join("")),await this.insertNestedHTML(s,n)}insertModules(e){const t=/<%#.*?%>/g,s=/<%# */g,l=/ *%>/g;let{types:r,codes:i}=this.seperateCode(e,"first"),n=0,h=r.length;for(let e=0;e<h;e++)if("JS"==r[e]&&i[e].includes("<%#")){let r=" "+i[e].match(t)[0].replace(s,"").replace(l,"");try{i[e]=this.basicCode(r),n++}catch{i[e]='<%= "invalid module" %>',n++}}let o=i.join("");return 0!==n&&(o=this.insertModules(o)),o}seperateCode(e,t){const s=`(${this.openDelimiter}[^%][\\s\\S]*?${this.closeDelimiter})`,l=new RegExp(s,"g");let r=e.split(l),i=[],n=r.length;for(let e=0;e<n;e++){let s=r[e],n=l.test(s)?"JS":"HTML";r[e]="JS"===n&&"second"===t?s.substring(2,s.length-2).trim():s,i.push(n)}let h=i.length;if(h>1)for(let e=h-1;e>=1;e--)i[e]==i[e-1]&&"HTML"==i[e]&&(r[e-1]=r[e-1]+r[e],r.splice(e,1),i.splice(e,1));return{types:i,codes:r}}interpret(e,t){let s=[],l=0,r=this.escapeHtml(this.commentDelimiter.replace(this.commentDelimiter,this.openDelimiter)),i=this.escapeHtml(this.closeDelimiter),n=t.length;for(;l<n;){switch(e[l]){case"HTML":s.push(t[l].replaceAll(this.commentDelimiter,r).replaceAll(this.closeDelimiter,i));break;case"JS":if(0==t[l].search(/=|-/g)){try{s.push(this.basicCode(t[l]))}catch(e){s.push("invalid template")}break}{let r=this.eachBlock(e,t,l);l=r.index;try{s.push(this.controlCode(r.partBlock))}catch(e){s.push("invalid template")}break}}l++}return s}interpretPart(e,t){let s=[],l=-1,r=-1;for(let i=0;i<t.length;i++){let n=t[i],h=e[i],o=this.htmlSync[i];if(o!=r&&"JS"==h&&(l++,r=o),"HTML"==h)continue;if(0==n.search(/=|-/g)){if(null==this.templateInClass[l]){try{s.push(this.basicCode(n))}catch(e){s.push("invalid template script")}continue}try{this.htmlSync[i]!=this.htmlSync[i-1]?s.push([this.basicCode(n)]):s[s.length-1].push(this.basicCode(n))}catch(e){s.push("invalid template script")}continue}let a=this.eachBlock(e,t,i);i=a.index;try{s.push(this.controlCode(a.partBlock))}catch(e){s.push("invalid template script")}}return s}makeSyncBlock(e,t){let s=[],l=0,r=0,i=0,n=t.length;for(let h=0;h<n;h++){switch(e[h]){case"HTML":s.push(l);break;case"JS":if(0==t[h].search(/=|-/g)){s.push(l);break}{let n=this.findBlockEnd(e,t,h);r=n.index,i=n.braceBalance,i<0?console.log("ERROR: missing {"):i>0&&console.log("ERROR: missing }"),s=[...s,...Array(r-h+1).fill(l)],h=r;break}}l++}return s}findBlockEnd(e,t,s){let l=0,r=0,i=t.length;for(r=s;r<i;r++)if(r!=s||"JS"!=e[r]){if("HTML"!=e[r]&&"JS"==e[r]&&0!==t[r].search(/=|-/g)&&(t[r].includes("{")&&l++,t[r].includes("}")&&l--,0==l))return{index:r,error:0}}else if(t[r].includes("{")&&l++,t[r].includes("}")&&l--,0==l)return{index:r,error:0};return 0!=l?{index:s,braceBalance:l}:{index:r,braceBalance:l}}eachBlock(e,t,s){let l="",r=0,i=t.length,n=0;for(n=s;n<i;n++){if(n==s){if("JS"==e[n]){if(t[n].includes("{")&&r++,t[n].includes("}")&&r--,0==r)return{partBlock:t[n],index:n};l=`let eTemplateInterpreted=${String.fromCharCode(96)}${String.fromCharCode(96)}; ${t[n]}`;continue}l=`let eTemplateInterpreted=${String.fromCharCode(96)}${t[n]}${String.fromCharCode(96)};`}switch(e[n]){case"HTML":""!==this.removeControlText(t[n]).trim()&&(l+=`eTemplateInterpreted += ${String.fromCharCode(96)}${t[n]}${String.fromCharCode(96)};`);continue;case"JS":if(0==t[n].search(/=|-/g))l+=`eTemplateInterpreted += ${t[n].substring(1)};`;else if(l+=t[n],t[n].includes("{")&&r++,t[n].includes("}")&&r--,0==r)return l+="; return eTemplateInterpreted;",{partBlock:l,index:n}}}return l+="; return eTemplateInterpreted;",{partBlock:l,index:n}}insertSync(e,t,s){let l=-1,r=0,i=0,n=0,h="",o="",a="",c=0,u=0,p=0,d=[],m=this.syncCnt,f=s.length;const y=this.syncClass,g=/[\s]+((-|\w)+) *= *["']/g,C=/[\s\S]+class[\s]*= *["']/g;for(let S=0;S<f;S++){if("JS"==e[S]&&(t[S]=t[S].trim()),s[S]==l||"JS"!=e[S]){l=s[S];continue}l=s[S],p=0,c=S,u=s.lastIndexOf(s[c]),a=t[S-1],d=[];let b=this.removeControlText(a),T=b.length-b.trimEnd().length;if(">"==b.substring(b.length-T-1).trim())if(r=a.lastIndexOf("<"),i=a.lastIndexOf(">"),n=a.indexOf(" ",r),o=-1==n||n>i?a.substring(r+1,i):a.substring(r+1,a.length).split(" ")[0],"</"!=a.substring(r,r+2))if(t[u+1].includes("</"+o)&&t[u+1].indexOf("</"+o)<(-1==t[u+1].indexOf("<"+o)?t[u+1].length:t[u+1].indexOf("<"+o))){if(0==this.removeControlText(t[u+1]).trim().indexOf("</"+o)){if(i=a.length,r=a.lastIndexOf("<"),h=a.substring(r,i),h.includes("class=")){p=a.indexOf("class=",r)+7,t[S-1]=`${a.substring(0,p)}${y} ${y}Cnt${m} ${a.substring(p)}`,m++;continue}i=a.lastIndexOf(">"),t[S-1]=`${a.substring(0,i)} class="${y} ${y}Cnt${m}" ${a.substring(i,a.length)}`,m++;continue}r=0,i=t[u+1].indexOf("</"),t[S-1]=`${t[S-1]}<span class="${y} ${y}Cnt${m}">`,m++,t[u+1]=`</span>${t[u+1]}`}else t[S-1]=`${t[S-1]}<span class="${y} ${y}Cnt${m}">`,m++,t[u+1]=`</span>${t[u+1]}`;else t[S-1]=`${t[S-1]}<span class="${y} ${y}Cnt${m}">`,m++,t[u+1]=`</span>${t[u+1]}`;else{if(i=a.lastIndexOf(">"),r=a.lastIndexOf("<"),i<r){for(let l=S+1;l<f;l++)if("HTML"===e[l]&&t[l].indexOf(">")>0){for(let e=S+1;e<l;e++)s[e]=s[S];u=s.lastIndexOf(s[S]);break}let l=-1,n="";for(let s=S;s<=u;s++)if("JS"===e[s]){for(let e=s-1;e>=0;e--){let s=[...t[e].matchAll(g)];if(s.length>0){n=s[s.length-1][1],"class"==n&&(l=e);break}}""!=n&&d.push(n)}for(let s=S-1;s<=u+1;s++)if("HTML"===e[s]&&null!==t[s].match(g)&&"JS"==e[s+1]){let e=t[s].lastIndexOf("class");if(s==S-1&&e>r){l=s;break}if(s>S&&e<t[s].indexOf(">")){l=s;break}}let h=[...new Set(d)].join("+"),o=[];for(let s=S;s<=u;s++)"JS"==e[s]&&o.push(this.basicCode(t[s].substring(1)));if(d.length>0&&(this.templateInClass[m]=[],d.map(((e,t)=>{this.templateInClass[m].push([e,o[t]])}))),-1===l)r=a.lastIndexOf("<"),i=a.indexOf(" ",r),t[S-1]=`${a.substring(0,i+1)} class="${y} ${y}_${h} ${y}Cnt${m}" ${a.substring(i+1)}`,m++;else{let e=t[l].match(C)[0],s=t[l].replace(e,"");t[l]=`${e}${y} ${y}_${h} ${y}Cnt${m} ${s}`,m++}continue}t[S-1]+=`<span class="${y} ${y}Cnt${m}">`,m++,t[u+1]="</span>"+t[u+1]}}return{type:e,code:t,syncCnt:m}}getTitle(e){const t=/<head>[\s\S]*?<\/head>/g,s=/<title>[\s\S]*?<\/title>/g,l=null==e.match(t)?"":e.match(t)[0],r=null==l.match(s)?"":l.match(s)[0].replace("<title>","").replace("</title>","").trim();this.titleCode=r.length>0?r:this.titleCode}changeTitle(e){const t=`${this.openDelimiter}[^%][\\s\\S]*?${this.closeDelimiter}`,s=new RegExp(t,"g");let l=null,r="",i=!1;null!=e.trim().match(s)?(l=e.trim().match(s)[0].replaceAll(`${this.openDelimiter}`,"").replaceAll(`${this.closeDelimiter}`,""),i=!0):r=e,i&&(r=this.basicCode(l)),document.querySelector("title")&&(document.querySelector("title").innerHTML=r)}readMeta(e){const t=document.createElement("document");t.insertAdjacentHTML("beforeend",e);const s=t.querySelectorAll("meta");let l=[];s.forEach(((e,t)=>{for(let s=0;s<e.attributes.length;s++)e.attributes[s].value.indexOf(this.openDelimiter)>-1&&l.push({metaNo:t,attributeNo:s,nodeName:e.attributes[s].name,nodeValue:e.attributes[s].value})})),this.metaArray=JSON.parse(JSON.stringify(l))}changeMeta(){if(0==this.metaArray.length)return;const e=`(${this.openDelimiter}[^%][\\s\\S]*?${this.closeDelimiter})`,t=new RegExp(e,"g");let s=document.querySelectorAll("meta");this.metaArray.forEach((e=>{let l=e.nodeValue.split(t),r=!1;for(let e=0;e<l.length;e++){if(-1==l[e].indexOf(this.openDelimiter))continue;let t=l[e].replace(this.openDelimiter,"").replace(this.closeDelimiter,"").trim(),s=this.basicCode(t.substring(1));l[e]=s,r=!0}r&&(s[e.metaNo].attributes[e.attributeNo].nodeValue=l.join(""))}))}removeComment(e){return e.replace(/<!--[\s\S]*?-->/gm,"")}async changeCss(e){e=this.removeComment(e);let t=await this.combineCss(e),{types:s,codes:l}=this.seperateCode(t,"second");this.cssCode=l,this.cssType=s,t=this.interpret(s,l).join("");let r=this.parseCSS(t);this.cssRules=r;const i=this.createTextStyle(r);if(""==i)return;document.querySelectorAll("style").forEach((e=>{e.parentNode.removeChild(e)}));let n=document.createElement("style");n.appendChild(document.createTextNode(i)),document.head.appendChild(n),document.head.querySelectorAll("link").forEach((e=>{"stylesheet"!=e.getAttribute("rel")||e.getAttribute("href").includes("http")||e.parentNode.removeChild(e)}))}changeCssFromCombinedStyle(e){let{types:t,codes:s}=this.seperateCode(e,"second");this.cssCode=s,this.cssType=t,e=this.interpret(t,s).join("");let l=this.parseCSS(e);this.cssRules=l;const r=this.createTextStyle(l);if(""==r)return;document.querySelectorAll("style").forEach((e=>{e.parentNode.removeChild(e)}));let i=document.createElement("style");i.appendChild(document.createTextNode(r)),document.head.appendChild(i),document.head.querySelectorAll("link").forEach((e=>{"stylesheet"==e.getAttribute("rel")&&e.getAttribute("href").indexOf("http")<0&&e.parentNode.removeChild(e)}))}async combineCss(e){let t=[],s=[],l=e.indexOf("<head>"),r=e.indexOf("</head>");if(-1==l||-1==r)return"";e.replace(/<style>[\s\S]*?<\/style>/gi,(function(e){return s.push(e.replaceAll("<style>","").replaceAll("</style>","")),""}));let i=s.join(""),n=[];e.replace(/<link.*?rel="stylesheet"[\s\S]*?\/?>/gi,(function(e){return n.push(e),""}));let h=this.currentUrl().host;n.forEach((e=>{let s=e.match(/href=".*?"/gi)[0].replaceAll("href=","").replaceAll('"',"");s.indexOf("http")<0&&t.push(new URL(s,h).href)})),t=t.map((e=>this.removeControlText(e)));let o=await this.getTextFromFiles(t),a=[];t.forEach((e=>{a.push(this.getComparedPath(e,this.currentUrl().host))}));for(let e=0;e<o.length;e++)o[e]=this.replaceRelativeUrl(o[e],a[e]);return i+=o.join(""),i=await this.insertNestedCSS(i),i}getOnlyPath(e){let t=e.split("/");return t.pop(),t.join("/")}splitUrl(e){let t=e.split("/");return""==t[t.length-1]&&t.pop(),""==t[0]&&t.shift(),t}getRelativeUrl(e){let t=this.currentUrl().host,s=this.splitUrl(e),l=this.splitUrl(t),r=[];for(let e=0;e<l.length;e++)l[e]!==s[e]?r.push(".."):s[e]=".";s=[...r,...s];for(let e=0;e<s.length;e++)"."==s[e]&&"."==s[e+1]&&(s[e]="_erase_");for(let e=s.length-1;e>=0;e--)("_erase_"==s[e]||"."==s[e]&&e>0)&&s.splice(e,1);return"/"+s.join("/")+"/"}getComparedPath(e,t){e=this.getOnlyPath(e),e=this.getRelativeUrl(e),t=this.getRelativeUrl(t);let s=this.splitUrl(e),l=this.splitUrl(t),r=[];for(let e=0;e<l.length;e++)l[e]!==s[e]?""!==l[e]&&r.push(".."):s[e]=".";return s=[...r,...s],s.join("/")+"/"}replaceRelativeUrl(e,t){function s(e,t){if(!e.includes("/"))return t+e;if("/"==e.substring(0,1))return t+e.substring(1);if("./"==e.substring(0,2))return t+e.substring(2);if("../"==e.substring(0,3)){let s=[...e.matchAll(/\.\.\//g)].length,l=t.split("/");for(l.pop();l.length>=0&&s>0;)l.pop(),s--;return(t="."+l.join("/")+"/")+e.substring(3)}}if(e.includes("base64,")||e.includes("http"))return e;return e.replace(/(@import *['"])(.*?)(['"])|(url\(['"]?)(.*?)(['"]?\))/g,(function(e,l,r,i,n,h,o){return null==l?n+(h=s(h,t))+o:l+(r=s(r,t))+i}))}htmlReplaceRelativeUrl(e,t){const s=`(\\<[a-z]* *src *= *['"])((?!http|${this.openDelimiter}).*)(['"])|(href *= *['"])((?!http|${this.openDelimiter}|#).*[^\\>\\%])(['"])|(${this.openDelimiter}[^\\%] *include *\\(?["'])(.*)(["'])`,l=new RegExp(s,"g");function r(e,t){if(!e.includes("/"))return t+e;if("/"==e.substring(0,1))return t+e.substring(1);if("./"==e.substring(0,2))return t+e.substring(2);if("../"==e.substring(0,3)){let s=[...e.matchAll(/\.\.\//g)].length,l=t.split("/");for(l.pop();l.length>=0&&s>0;)l.pop(),s--;return(t="."+l.join("/")+"/")+e.substring(3)}}return e.replace(l,(function(e,s,l,i,n,h,o,a,c,u){return void 0!==s?s+(l=r(l,t))+i:void 0!==n?n+(h=r(h,t))+o:a+(c=r(c,t))+u}))}async insertNestedCSS(e){let t="",{urls:s,orders:l,codes:r,media:i}=this.findImport(e);if(t=r.join(""),0==s.length)return t;let n=await this.getTextFromFiles(s),h=[];s.forEach((e=>{h.push(this.getComparedPath(e,this.currentUrl().host))}));for(let e=0;e<n.length;e++)n[e]=this.replaceRelativeUrl(n[e],h[e]);return n.forEach(((e,t)=>{r[l[t]]=""!==i[t]?this.insertMedia(e,i[t]):e})),t=r.join(""),await this.insertNestedCSS(t)}insertMedia(e,t){return`@media ${t} { ${e} }`}findImport(e){let t=[],s=[],l=[],r=[],i="",n=0;const h=/(@import *?(?:url)?\(?["'].*["']\)? *?.*;)/g,o=/[^(?:\.)|(?:\.\/)].*/g;let a=e.split(h);t=[...e.matchAll(/@import *?(url)?\(?["'](.*)["']\)? *?(.*);/g)];for(let e=0;e<a.length;e++)-1==a[e].search(h)||a[e].includes("http")?a[e]=this.removeControlText(a[e]).trim():(r[n]=e,n++);return t.forEach((e=>{i=e[2].match(o)[0].trim(),s.push(this.currentUrl().host+i),l.push(null===e[3]?"":e[3].trim())})),{urls:s,orders:r,codes:a,media:l}}createTextStyle(e){let t="",s=e.length;for(let l=0;l<s;l++){let s=e[l];switch(null==s.type?"":s.type){case"":case"font-face":t=t+s.selector+" {\n",s.rules.forEach((e=>{t+=`    ${e.key}: ${e.value};\n`})),t+="}\n";break;case"imports":case"keyframes":t+=s.styles.replaceAll("{","{\n").replaceAll("}","}\n").replaceAll(";",";\n")+"\n";break;case"supports":case"media":t+=s.selector+" {\n",s.subStyles.forEach((e=>{t+="    "+e.selector+" {\n",e.rules.forEach((e=>{t+=`        ${e.key}: ${e.value};\n`})),t+="    }\n"})),t+="}\n"}}return t}async renderPart(e="",t=""){let s="",l="",r=[],i=[],n="",h="",o=[],a=[],c="";if(""==t.trim())return"select type from html, html_path";if(""==e.trim())return"nothing to render";switch(t){case"HTML":s=e;let{fileIncludedHTML:t,codeList:u}=await this.insertNestedHTML(s),p=this.insertModules(t);return r=this.seperateCode(p,"second"),i=this.makeSyncBlock(r.types,r.codes),"JS"==r.types[0]&&(r.types.unshift("HTML"),r.codes.unshift(" "),i=i.map((e=>e+1)),i.unshift(0)),r=this.insertSync(r.types,r.codes,i),this.syncCnt=r.syncCnt,l=this.interpret(r.type,r.code),n=l.join(""),{domText:n,sourceType:r.type,sourceCode:r.code,sourceSync:i};case"CSS":return s=e,s=await this.insertNestedCSS(s),r=this.seperateCode(s,"second"),o=this.interpret(r.type,r.code),h=o.join(""),a=this.parseCSS(h),c=this.createTextStyle(a),{cssText:c,cssRules:a,cssType:r.type,cssCode:r.code}}}async appendHTML(e="",t){if(""==e)return"nothing to append";let s=await this.renderPart(e,"HTML"),l=s.domText||"";if(null==t)return"no element to append to";const r=s.sourceType||[],i=s.sourceCode||[],n=s.sourceSync||[];return"DOMobject"!=this.getObjectType(t)?"invalid element to append into":0==r.length?"nothing to append":(this.htmlType=[...this.htmlType,...r],this.htmlCode=[...this.htmlCode,...i],this.htmlSync=[...this.htmlSync,...n],l=l.trim(),""==l?"nothing to append":(t.insertAdjacentHTML("beforeend",l),"success"))}async appendCSS(e=""){if(""==e)return;let t,s=await this.renderPart(e,"CSS"),l=s.cssText||"",r=s.cssRules||[],i=s.cssType||[],n=s.cssCode||[];return null==document.querySelector("style")?(t=document.createElement("style"),t.appendChild(document.createTextNode(l)),document.head.appendChild(t),this.cssRules=[...this.cssRules,...r],this.cssType=[...this.cssType,...i],this.cssCode=[...this.cssCode,...n],"success"):(t=document.createTextNode(l),document.querySelector("style").appendChild(t),this.cssRules=[...this.cssRules,...r],this.cssType=[...this.cssType,...i],this.cssCode=[...this.cssCode,...n],"success")}basicCode(e){try{return Function(`"use strict"; return ( ${e.substring(1)} )`)()}catch(t){return console.log(e),console.error(t),"invalid template"}}controlCode(e){e=this.removeControlText(e);try{return Function(`"use strict"; ${e.replace(/[\n\r\t]/g,"")}`)()}catch(e){return console.error(e),"invalid template block"}}currentUrl(){let e=window.location.href,t=window.location.hash;e=e.replace(t,"");let s=e.split("/").pop(),l=e.substring(0,e.length-s.length);return""!=t&&(s=t.substring(1)+".html"),{host:l,filename:s}}async getTextFromFiles(e){if(0==e.length)return[];let t=e.map((e=>fetch(e))),s=await Promise.allSettled(t),l=[];s.map(((e,t)=>{e.value.ok||l.push(t)})),s=s.filter((e=>e.value.ok));let r=s.map((e=>e.value));s=await Promise.all(r);let i=s.map((e=>e.text())),n=await Promise.all(i);return l.map((e=>n.splice(e,0,"error: check your path of include"))),n}removeAllChildNodes(e){for(;e.firstChild;)e.removeChild(e.firstChild)}parseCSS(e){if(void 0===e)return[];let t=/@import .*?\(.*?\);/g,s=/((@keyframes[\s\S]*?){([\s\S]*?}\s*?)})/g,l=[],r=[...(e=e.replace(/\/\*.*?\*\//g,"")).matchAll(t)],i=r.length;for(let e=0;e<i;e++){let t=r[e];l.push({selector:"@imports",type:"imports",styles:t[0]})}let n=[...(e=e.replace(t,"")).matchAll(s)],h=n.length;for(let e=0;e<h;e++){let t=n[e];l.push({selector:"@keyframes",type:"keyframes",styles:t[0]})}let o=[...(e=e.replace(s,"")).matchAll(/((\s*?(?:\/\*[\s\S]*?\*\/)?\s*?(@media|@supports)[\s\S]*?){([\s\S]*?)}\s*?})|(([\s\S]*?){([\s\S]*?)})/g)],a=o.length;for(let e=0;e<a;e++){let t=o[e],s=void 0===t[2]?t[6]:t[2];s=this.standardReturn(s);let r=s.includes("@media")?"media":s.includes("@supports")?"supports":"@font-face"===s?"font-face":"",i={selector:s,type:r};"media"===r||"supports"===r?i.subStyles=this.parseCSS(t[4]+"\n}"):i.rules=this.parseRules(t[7]),l.push(i)}return l}parseRules(e){let t=[],s=(e=this.standardReturn(e).split(";")).length;for(let l=0;l<s;l++){let s=e[l];if(s=s.trim(),s.includes(":")||"base64,"!==s.trim().substring(0,7)){if(s.includes(":")){s=s.split(":");let e=s[0].trim(),l=s.slice(1).join(":").trim();e.length>0&&l.length>0&&t.push({key:e,value:l})}}else t[t.length-1].value+=s.trim()}return t}standardReturn(e){return e.split("\r\n").join("\n").replace(/\n+/,"\n").trim()}arrayFind(e,t){let s={},l=e.length;for(let t=0;t<l;t++)s[e[t]]=t;return s.hasOwnProperty(t)?s[t]:-1}escapeHtml(e){let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;","(":"&#40;",")":"&#41;"};return e.replace(/[&<>"'()]/g,(function(e){return t[e]}))}removeControlText(e){return e.replaceAll(/\r|\n|\t/g,"")}verifyFilename(e){return 0==e.trim().length?"":new URL(e,this.currentUrl().host).href.replaceAll(this.currentUrl().host,"")}getObjectType(e){return("object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&null!==e&&1===e.nodeType&&"string"==typeof e.nodeName)?"DOMobject":e.includes(this.openDelimiter)&&e.includes(this.closeDelimiter)?"template":e.includes(".html")?"html_path":e.includes(".css")?"css_path":"undefined"}}